<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key è®¾ç½® - Project Lanlan</title>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important; 
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f7f8fa;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 32px 24px 24px 24px;
        }
        h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #333;
        }
        .section {
            margin-bottom: 32px;
        }
        .field-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .field-row label {
            min-width: auto;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .field-row label em {
            font-weight: normal;
        }
        .field-row input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }
        .field-row input:disabled {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }
        .field-row select:disabled {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }
        .field-row select option:disabled {
            color: #999;
        }
        .field-row input::placeholder {
            font-size: 0.9rem;
            color: #999;
        }
        .field-row input:focus {
            outline: none;
            border-color: #4f8cff;
            box-shadow: 0 0 0 2px rgba(79, 140, 255, 0.2);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            background: #4f8cff;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 12px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2662c8;
        }
        .btn:active {
            background: #1e4a9e;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #545b62;
        }
        .tips {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #current-api-key {
            background: #e7f3ff;
            color: #0d6efd;
            border: 1px solid #b3d9ff;
            font-weight: 500;
            margin-bottom: 16px;
        }
        .api-key-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .api-key-info h3 {
            margin-top: 0;
            color: #495057;
            font-size: 1.1em;
        }
        .api-key-info ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .api-key-info li {
            margin-bottom: 4px;
            color: #6c757d;
        }
        
        /* å¼¹å‡ºå¼è­¦å‘Šæ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-warning {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-warning h3 {
            margin-top: 0;
            color: #d63031;
            font-size: 1.2em;
        }
        
        .modal-warning ul {
            margin: 16px 0;
            padding-left: 20px;
        }
        
        .modal-warning li {
            margin-bottom: 8px;
            color: #495057;
            line-height: 1.4;
        }
        
        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        
        .modal-buttons .btn {
            margin-left: 10px;
        }

        /* æ‚¬æµ®æç¤ºçª—æ ·å¼ */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #4f8cff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85em;
            line-height: 1.4;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            width: 500px;
            white-space: normal;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 800px) {
            .container { 
                padding: 20px 16px; 
                margin: 20px 16px;
            }
            .tooltip-content {
                width: 350px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h2>API Key è®¾ç½®</h2>
    
    <div class="api-key-info">
        <h3>ğŸ“‹ å¿«é€Ÿå¼€å§‹</h3>
        <ul>
            <li><strong>å…è´¹ç‰ˆï¼ˆæ¨èæ–°æ‰‹ï¼‰ï¼š</strong>æ— éœ€æ³¨å†Œï¼Œåœ¨ä¸‹æ–¹é«˜çº§é€‰é¡¹ä¸­é€‰æ‹©"å…è´¹ç‰ˆ"å³å¯ä½¿ç”¨</li>
            <li><strong>å®Œæ•´ç‰ˆï¼ˆè·å–API Keyï¼‰ï¼š</strong></li>
            <li style="margin-left: 20px;">1. åœ¨é˜¿é‡Œäº‘æ³¨å†Œè´¦å·å¹¶ <a href="https://myaccount.console.aliyun.com/overview" target="_blank">å®Œæˆå®åè®¤è¯</a></li>
            <li style="margin-left: 20px;">2. è®¿é—®é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å° <a href="https://bailian.console.aliyun.com/api-key?tab=model#/api-key" target="_blank">API Keyç®¡ç†é¡µé¢</a></li>
            <li style="margin-left: 20px;">3. åˆ›å»ºæ–°çš„API Keyå¹¶å¤åˆ¶</li>
            <li style="margin-left: 20px;">4. å°†API Keyç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ä¸­</li>
        </ul>
    </div>



    <div class="section">
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 16px; margin-bottom: 16px; font-size: 0.95em; color: #155724; line-height: 1.5;">
            <strong>ğŸ‰ æ–°æ‰‹æ¨èï¼š</strong>å¦‚æœæ‚¨è¿˜æ²¡æœ‰API Keyï¼Œå¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹<strong>é«˜çº§é€‰é¡¹</strong>ä¸­é€‰æ‹©<strong>"å…è´¹ç‰ˆ"</strong>å¼€å§‹ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œä»»ä½•è´¦å·ï¼
        </div>
        <div class="tips">
            ğŸ’¡ è¯·ç¡®ä¿API Keyæ ¼å¼æ­£ç¡®ï¼Œé€šå¸¸ä»¥"sk-"å¼€å¤´ï¼ˆæ™ºè°±å’Œé˜¶è·ƒä¾‹å¤–ï¼‰ã€‚ä¿å­˜åéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚<br>
            ğŸ“ ä¸ªäººä½¿ç”¨ç¯å¢ƒï¼ŒAPI Keyå°†å®Œæ•´æ˜¾ç¤ºä»¥ä¾¿å¤åˆ¶ä½¿ç”¨ã€‚
        </div>
        
        <form id="api-key-form">
            <div class="field-row">
                <label>æ ¸å¿ƒAPI Key<span id="freeVersionHint" style="color: #28a745; font-weight: normal; display: none;">ï¼ˆå…è´¹ç‰ˆæ— éœ€å¡«å†™ï¼‰</span></label>
                <input type="text" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„API Key" required style="max-width: 600px;">
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button type="button" class="btn secondary" onclick="closeApiKeySettings()">âŒ å…³é—­</button>
            </div>
        </form>
        
        <div id="current-api-key" class="status info" style="display: none;"></div>
        <div id="status" class="status"></div>
    </div>

            <div id="advanced-section" class="section" style="margin-top: 0;">
        <div style="margin-bottom: 8px; cursor: pointer; user-select: none; display: flex; align-items: center;" onclick="toggleAdvancedOptions()">
            <span id="advanced-arrow" style="font-size: 1.2em; margin-right: 6px; transition: transform 0.2s;">â–¶</span>
            <span style="font-weight: bold; color: #333;">é«˜çº§é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</span>
            <div class="tooltip-container">
                <span class="tooltip-icon">?</span>
                <div class="tooltip-content">
                    <strong>APIæœåŠ¡å•†è¯´æ˜ï¼š</strong><br>
                    â€¢ <strong>æ ¸å¿ƒAPI</strong>ï¼šè´Ÿè´£å¯¹è¯åŠŸèƒ½<br>
                    â€¢ <strong>è¾…åŠ©API</strong>ï¼šè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³<br><br>
                    <strong>å„æœåŠ¡å•†ç‰¹ç‚¹ï¼š</strong><br>
                    â€¢ <strong>é˜¿é‡Œ</strong>ï¼šæœ‰å…è´¹é¢åº¦ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³<br>
                    â€¢ <strong>æ™ºè°±</strong>ï¼šå…è´¹é¢åº¦å¤šï¼Œå†…ç½®è”ç½‘æœç´¢åŠŸèƒ½<br>
                    â€¢ <strong>é˜¶è·ƒæ˜Ÿè¾°</strong>ï¼šæœ‰å…è´¹é¢åº¦ï¼Œä¸æ”¯æŒè§†é¢‘<br>
                    â€¢ <strong>OpenAI</strong>ï¼šéœ€è¦ç¿»å¢™ï¼Œä»·æ ¼è´µï¼Œæ™ºèƒ½æ°´å¹³é«˜
                </div>
            </div>
        </div>
        <div id="advanced-options" style="display: none; padding: 12px 0 0 0; border-top: 1px solid #eee;">
            <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 0.9em; color: #0d6efd; line-height: 1.5;">
                <strong>ğŸ’¡ é…ç½®å»ºè®®ï¼š</strong><br>
                â€¢ <strong>å…è´¹ç‰ˆ</strong>ï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API keyï¼Œé€‚åˆæ–°æ‰‹ä½“éªŒï¼ˆä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯ï¼‰<br>
                â€¢ <strong>æ ¸å¿ƒAPI</strong>ï¼šè´Ÿè´£å¯¹è¯åŠŸèƒ½ï¼Œå»ºè®®æ ¹æ®é¢„ç®—å’Œéœ€æ±‚é€‰æ‹©<br>
                â€¢ <strong>è¾…åŠ©API</strong>ï¼šè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼Œ<strong>åªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³</strong><br>
            </div>
            <div class="field-row">
                <label for="coreApiSelect">
                    æ ¸å¿ƒAPI
                    <div class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong>æ ¸å¿ƒAPIè´Ÿè´£å¯¹è¯åŠŸèƒ½ï¼š</strong><br>
                            â€¢ <strong>å…è´¹ç‰ˆ</strong>ï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API keyï¼Œä½†ä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯<br>
                            â€¢ <strong>é˜¿é‡Œ</strong>ï¼šæœ‰å…è´¹é¢åº¦ï¼ŒåŠŸèƒ½å…¨é¢<br>
                            â€¢ <strong>æ™ºè°±</strong>ï¼šæœ‰å…è´¹é¢åº¦ï¼Œä½†éœ€å……å€¼1å…ƒï¼Œå†…ç½®è”ç½‘æœç´¢åŠŸèƒ½<br>
                            â€¢ <strong>é˜¶è·ƒæ˜Ÿè¾°</strong>ï¼šå®Œå…¨å…è´¹ï¼Œä½†ä¸æ”¯æŒè§†é¢‘<br>
                            â€¢ <strong>OpenAI</strong>ï¼šæ™ºèƒ½æ°´å¹³æœ€é«˜ï¼Œä½†éœ€è¦ç¿»å¢™ä¸”ä»·æ ¼æ˜‚è´µ
                        </div>
                    </div>
                </label>
                <select id="coreApiSelect" style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;">
                    <option value="free">å…è´¹ç‰ˆï¼ˆlanlan.appï¼‰</option>
                    <option value="qwen">Qwen-Omniï¼ˆé˜¿é‡Œï¼‰</option>
                    <option value="openai">GPT-Realtimeï¼ˆOpenAIï¼‰</option>
                    <option value="glm">GLM-realtimeï¼ˆæ™ºè°±ï¼‰</option>
                    <option value="step">Step-2ï¼ˆé˜¶è·ƒæ˜Ÿè¾°ï¼‰</option>
                </select>
            </div>
            <div class="field-row">
                <label for="assistApiSelect">
                    è¾…åŠ©APIï¼ˆè®°å¿†ç®¡ç†/è‡ªå®šä¹‰è¯­éŸ³/æ–‡æœ¬èŠå¤©ï¼‰
                    <div class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong>è¾…åŠ©APIè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼š</strong><br>
                            â€¢ <strong>å…è´¹ç‰ˆ</strong>ï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API keyï¼Œä½†ä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³<br>
                            â€¢ <strong>é˜¿é‡Œ</strong>ï¼šæ¨èé€‰æ‹©ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³<br>
                            â€¢ <strong>æ™ºè°±</strong>ï¼šæ”¯æŒAgentæ¨¡å¼<br>
                            â€¢ <strong>é˜¶è·ƒæ˜Ÿè¾°</strong>ï¼šä»·æ ¼ç›¸å¯¹ä¾¿å®œ<br>
                            â€¢ <strong>ç¡…åŸºæµåŠ¨</strong>ï¼šæ€§ä»·æ¯”é«˜<br>
                            â€¢ <strong>OpenAI</strong>ï¼šè®°å¿†ç®¡ç†èƒ½åŠ›å¼º<br>
                            <strong>æ³¨æ„ï¼š</strong>åªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½
                        </div>
                    </div>
                </label>
                <select id="assistApiSelect" style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;">
                    <option value="free">å…è´¹ç‰ˆï¼ˆlanlan.appï¼‰</option>
                    <option value="qwen">é˜¿é‡Œï¼ˆæ¨èï¼‰</option>
                    <option value="openai">OpenAI</option>
                    <option value="glm">æ™ºè°±</option>
                    <option value="step">é˜¶è·ƒæ˜Ÿè¾°</option>
                    <option value="silicon">ç¡…åŸºæµåŠ¨</option>
                </select>
            </div>
            <div class="field-row">
                <label for="assistApiKeyInputQwen">è¾…åŠ©API Key - é˜¿é‡Œ<em>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºé˜¿é‡Œæ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                <input type="text" id="assistApiKeyInputQwen" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
            </div>
            <div class="field-row">
                <label for="assistApiKeyInputOpenai">è¾…åŠ©API Key - OpenAI<em>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºOpenAIæ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                <input type="text" id="assistApiKeyInputOpenai" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
            </div>
            <div class="field-row">
                <label for="assistApiKeyInputGlm">è¾…åŠ©API Key - æ™ºè°±<em>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºæ™ºè°±æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                <input type="text" id="assistApiKeyInputGlm" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
            </div>
            <div class="field-row">
                <label for="assistApiKeyInputStep">è¾…åŠ©API Key - é˜¶è·ƒæ˜Ÿè¾°<em>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºé˜¶è·ƒæ˜Ÿè¾°æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                <input type="text" id="assistApiKeyInputStep" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
            </div>
            <div class="field-row">
                <label for="assistApiKeyInputSilicon">è¾…åŠ©API Key - ç¡…åŸºæµåŠ¨<em>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºç¡…åŸºæµåŠ¨æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                <input type="text" id="assistApiKeyInputSilicon" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
            </div>
            
            <!-- æ·»åŠ MCP Router Tokenè®¾ç½® -->
            <div class="field-row">
                <label for="mcpTokenInput">
                    MCP Router Token
                    <div class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong>MCP Router Tokenè¯´æ˜ï¼š</strong><br>
                            ç”¨äºè®¿é—®MCP RouteræœåŠ¡çš„è®¤è¯ä»¤ç‰Œï¼Œå¯ç”¨MCPåŠŸèƒ½æ—¶éœ€è¦å¡«å†™ã€‚å¦‚æœæ‚¨çš„MCP Routerä¸éœ€è¦è®¤è¯ï¼Œå¯ä»¥ç•™ç©ºã€‚
                        </div>
                    </div>
                </label>
                <input type="text" id="mcpTokenInput" placeholder="è¯·è¾“å…¥MCP Router Tokenï¼ˆå¯é€‰ï¼‰" value="" style="max-width: 600px;">
            </div>
        </div>
    </div>
</div>

<!-- å¼¹å‡ºå¼è­¦å‘Š -->
<div id="warning-modal" class="modal-overlay" onclick="closeWarningModal()">
    <div class="modal-warning" onclick="event.stopPropagation()">
        <h3>âš ï¸ é‡è¦æé†’</h3>
        <p>æ£€æµ‹åˆ°æ‚¨æ­£åœ¨æ›´æ¢ API Keyï¼Œè¯·æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p>
        <ul>
            <li>Voice ID ä¸æ‚¨çš„ API Key ç»‘å®šï¼Œæ›´æ¢ API Key åæ‰€æœ‰å·²æ³¨å†Œçš„ Voice ID å°†å¤±æ•ˆ</li>
            <li>ç³»ç»Ÿä¼šåœ¨æ‚¨ä¿å­˜æ–°çš„ API Key åè‡ªåŠ¨æ¸…é™¤æœ¬åœ°ä¿å­˜çš„ Voice ID è®°å½•</li>
            <li>å»ºè®®åœ¨æ›´æ¢ API Key åé‡æ–°æ³¨å†Œæ‰€éœ€çš„éŸ³è‰²</li>
        </ul>
        <div class="modal-buttons">
            <button type="button" class="btn secondary" onclick="closeWarningModal()">å–æ¶ˆ</button>
            <button type="button" class="btn" onclick="confirmApiKeyChange()">ç»§ç»­ä¿å­˜</button>
        </div>
    </div>
</div>

<script>

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }
}

function showCurrentApiKey(message) {
    const currentApiKeyDiv = document.getElementById('current-api-key');
    currentApiKeyDiv.textContent = message;
    currentApiKeyDiv.style.display = 'block';
}

async function clearVoiceIds() {
    try {
        const response = await fetch('/api/characters/clear_voice_ids', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log(`API Keyå·²æ›´æ”¹ï¼Œå·²è‡ªåŠ¨æ¸…é™¤ ${data.cleared_count} ä¸ªè§’è‰²çš„Voice IDè®°å½•`);
        } else {
            console.error('è‡ªåŠ¨æ¸…é™¤Voice IDè®°å½•å¤±è´¥:', data.error);
        }
    } catch (error) {
        console.error('è‡ªåŠ¨æ¸…é™¤Voice IDè®°å½•æ—¶å‡ºé”™:', error);
    }
}

async function loadCurrentApiKey() {
    try {
        const response = await fetch('/api/config/core_api');
        if (response.ok) {
            const data = await response.json();
            // è®¾ç½®API Keyæ˜¾ç¤º
            if (data.api_key) {
                if (data.api_key === 'free-access' || data.coreApi === 'free' || data.assistApi === 'free') {
                    showCurrentApiKey('ğŸ“‹ å½“å‰ä½¿ç”¨ï¼šå…è´¹ç‰ˆï¼ˆæ— éœ€API Keyï¼‰');
                } else {
                    showCurrentApiKey(`ğŸ“‹ å½“å‰API Key: ${data.api_key}`);
                }
            } else {
                showCurrentApiKey('ğŸ“‹ å½“å‰æš‚æœªè®¾ç½®API Key');
            }
            // è®¾ç½®é«˜çº§è®¾å®šçš„å€¼
            if (data.coreApi && document.getElementById('coreApiSelect')) {
                document.getElementById('coreApiSelect').value = data.coreApi;
            }
            if (data.assistApi && document.getElementById('assistApiSelect')) {
                document.getElementById('assistApiSelect').value = data.assistApi;
            }
            if (typeof data.assistApiKeyQwen === 'string' && document.getElementById('assistApiKeyInputQwen')) {
                document.getElementById('assistApiKeyInputQwen').value = data.assistApiKeyQwen;
                document.getElementById('assistApiKeyInputQwen').placeholder = data.assistApiKeyQwen || 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key';
            }
            if (typeof data.assistApiKeyOpenai === 'string' && document.getElementById('assistApiKeyInputOpenai')) {
                document.getElementById('assistApiKeyInputOpenai').value = data.assistApiKeyOpenai;
                document.getElementById('assistApiKeyInputOpenai').placeholder = data.assistApiKeyOpenai || 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key';
            }
            if (typeof data.assistApiKeyGlm === 'string' && document.getElementById('assistApiKeyInputGlm')) {
                document.getElementById('assistApiKeyInputGlm').value = data.assistApiKeyGlm;
                document.getElementById('assistApiKeyInputGlm').placeholder = data.assistApiKeyGlm || 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key';
            }
            if (typeof data.assistApiKeyStep === 'string' && document.getElementById('assistApiKeyInputStep')) {
                document.getElementById('assistApiKeyInputStep').value = data.assistApiKeyStep;
                document.getElementById('assistApiKeyInputStep').placeholder = data.assistApiKeyStep || 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key';
            }
            if (typeof data.assistApiKeySilicon === 'string' && document.getElementById('assistApiKeyInputSilicon')) {
                document.getElementById('assistApiKeyInputSilicon').value = data.assistApiKeySilicon;
                document.getElementById('assistApiKeyInputSilicon').placeholder = data.assistApiKeySilicon || 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key';
            }
            
            // åŠ è½½MCPR_TOKEN
            if (typeof data.mcpToken === 'string' && document.getElementById('mcpTokenInput')) {
                document.getElementById('mcpTokenInput').value = data.mcpToken;
            }
        } else {
            showCurrentApiKey('ğŸ“‹ è·å–å½“å‰API Keyå¤±è´¥');
        }
    } catch (error) {
        showCurrentApiKey('ğŸ“‹ è·å–å½“å‰API Keyæ—¶å‡ºé”™');
    }
}

// å…¨å±€å˜é‡å­˜å‚¨å¾…ä¿å­˜çš„API Key
let pendingApiKey = null;

document.getElementById('api-key-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const apiKeyInput = document.getElementById('apiKeyInput');
    const apiKey = apiKeyInput.value ? apiKeyInput.value.trim() : '';
    // è·å–é«˜çº§è®¾å®šçš„å€¼
    const coreApi = document.getElementById('coreApiSelect') ? document.getElementById('coreApiSelect').value : '';
    const assistApi = document.getElementById('assistApiSelect') ? document.getElementById('assistApiSelect').value : '';
    const assistApiKeyQwen = document.getElementById('assistApiKeyInputQwen') ? document.getElementById('assistApiKeyInputQwen').value.trim() : '';
    const assistApiKeyOpenai = document.getElementById('assistApiKeyInputOpenai') ? document.getElementById('assistApiKeyInputOpenai').value.trim() : '';
    const assistApiKeyGlm = document.getElementById('assistApiKeyInputGlm') ? document.getElementById('assistApiKeyInputGlm').value.trim() : '';
    const assistApiKeyStep = document.getElementById('assistApiKeyInputStep') ? document.getElementById('assistApiKeyInputStep').value.trim() : '';
    const assistApiKeySilicon = document.getElementById('assistApiKeyInputSilicon') ? document.getElementById('assistApiKeyInputSilicon').value.trim() : '';
    const mcpToken = document.getElementById('mcpTokenInput') ? document.getElementById('mcpTokenInput').value.trim() : '';

    // å…è´¹ç‰ˆä¸éœ€è¦API Keyæ£€æŸ¥
    if (coreApi !== 'free' && assistApi !== 'free' && !apiKey) {
        showStatus('è¯·è¾“å…¥API Key', 'error');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰API Keyï¼Œå¦‚æœæœ‰åˆ™æ˜¾ç¤ºè­¦å‘Š
    const currentApiKeyDiv = document.getElementById('current-api-key');
    if (currentApiKeyDiv.style.display !== 'none') {
        // å·²æœ‰API Keyï¼Œæ˜¾ç¤ºè­¦å‘Šå¼¹çª—
        pendingApiKey = { apiKey, coreApi, assistApi, assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon, mcpToken };
        showWarningModal();
    } else {
        // æ²¡æœ‰ç°æœ‰API Keyï¼Œç›´æ¥ä¿å­˜
        await saveApiKey({ apiKey, coreApi, assistApi, assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon, mcpToken });
    }
});

async function saveApiKey({ apiKey, coreApi, assistApi, assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon, mcpToken }) {
    // ç¡®ä¿apiKeyæ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²
    if (!apiKey || typeof apiKey !== 'string') {
        showStatus('API Keyæ— æ•ˆ', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/config/core_api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                coreApiKey: apiKey,
                coreApi: coreApi || undefined,
                assistApi: assistApi || undefined,
                assistApiKeyQwen: assistApiKeyQwen || undefined,
                assistApiKeyOpenai: assistApiKeyOpenai || undefined,
                assistApiKeyGlm: assistApiKeyGlm || undefined,
                assistApiKeyStep: assistApiKeyStep || undefined,
                assistApiKeySilicon: assistApiKeySilicon || undefined,
                mcpToken: mcpToken || undefined
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showStatus('API Keyä¿å­˜æˆåŠŸï¼', 'success');
                document.getElementById('apiKeyInput').value = '';
                
                // æ¸…é™¤æœ¬åœ°Voice IDè®°å½•
                await clearVoiceIds();
                // é€šçŸ¥å…¶ä»–é¡µé¢API Keyå·²æ›´æ”¹
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'api_key_changed',
                        timestamp: Date.now()
                    }, '*');
                } else {
                    // å¦‚æœæ˜¯ç›´æ¥æ‰“å¼€çš„é¡µé¢ï¼Œå¹¿æ’­ç»™æ‰€æœ‰å­çª—å£
                    const iframes = document.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        try {
                            iframe.contentWindow.postMessage({
                                type: 'api_key_changed',
                                timestamp: Date.now()
                            }, '*');
                        } catch (e) {
                            // è·¨åŸŸiframeä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¿½ç•¥
                        }
                    });
                }
            } else {
                showStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } else {
            showStatus('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        }
        
        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡æ–°åŠ è½½å½“å‰API Key
        await loadCurrentApiKey();
    } catch (error) {
        showStatus('ä¿å­˜æ—¶å‡ºé”™: ' + error.message, 'error');
        // å³ä½¿å‡ºé”™ä¹Ÿå°è¯•é‡æ–°åŠ è½½å½“å‰API Key
        await loadCurrentApiKey();
    }
}

function showWarningModal() {
    document.getElementById('warning-modal').style.display = 'flex';
}

function closeWarningModal() {
    document.getElementById('warning-modal').style.display = 'none';
    // ä¸åœ¨è¿™é‡Œæ¸…ç©º pendingApiKeyï¼Œè®©è°ƒç”¨è€…å†³å®šä½•æ—¶æ¸…ç©º
}

function confirmApiKeyChange() {
    if (pendingApiKey && typeof pendingApiKey === 'object') {
        const apiKeyToSave = pendingApiKey; // ä¿å­˜å½“å‰å€¼
        closeWarningModal();
        pendingApiKey = null; // æ¸…ç©ºå…¨å±€å˜é‡
        saveApiKey(apiKeyToSave); // ä½¿ç”¨ä¿å­˜çš„å€¼
    } else {
        showStatus('API Keyæ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
        closeWarningModal();
        pendingApiKey = null; // æ¸…ç©ºå…¨å±€å˜é‡
    }
}

function toggleAdvancedOptions() {
    const adv = document.getElementById('advanced-options');
    const arrow = document.getElementById('advanced-arrow');
    if (adv.style.display === 'none') {
        adv.style.display = 'block';
        arrow.style.transform = 'rotate(90deg)';
    } else {
        adv.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// æ ¹æ®æ ¸å¿ƒAPIé€‰æ‹©æ›´æ–°è¾…åŠ©APIçš„æç¤ºå’Œå»ºè®®
function updateAssistApiRecommendation() {
    const coreApiSelect = document.getElementById('coreApiSelect');
    const assistApiSelect = document.getElementById('assistApiSelect');
    
    if (!coreApiSelect || !assistApiSelect) return;
    
    const selectedCoreApi = coreApiSelect.value;
    const selectedAssistApi = assistApiSelect.value;
    let recommendation = '';
    
    // æ§åˆ¶API Keyè¾“å…¥æ¡†å’Œå…è´¹ç‰ˆæç¤º
    const apiKeyInput = document.getElementById('apiKeyInput');
    const freeVersionHint = document.getElementById('freeVersionHint');
    
    if (selectedCoreApi === 'free') {
        // æ ¸å¿ƒAPIé€‰æ‹©å…è´¹ç‰ˆæ—¶ï¼Œè‡ªåŠ¨å±è”½è¾…åŠ©APIé€‰æ‹©ï¼Œå¼ºåˆ¶ä½¿ç”¨å…è´¹ç‰ˆ
        if (apiKeyInput) {
            apiKeyInput.disabled = true;
            apiKeyInput.placeholder = 'å…è´¹ç‰ˆæ— éœ€API Key';
            apiKeyInput.required = false;
            apiKeyInput.value = 'free-access';
        }
        if (freeVersionHint) {
            freeVersionHint.style.display = 'inline';
        }
        
        // ç¦ç”¨è¾…åŠ©APIé€‰æ‹©æ¡†ï¼Œå¼ºåˆ¶ä¸ºå…è´¹ç‰ˆ
        assistApiSelect.disabled = true;
        assistApiSelect.value = 'free';
        recommendation = 'å…è´¹ç‰ˆé…ç½®ï¼šæ”¯æŒè¯­éŸ³å¯¹è¯ã€æ–‡æœ¬å¯¹è¯å’Œè®°å¿†ç®¡ç†ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯';
    } else {
        // æ ¸å¿ƒAPIä¸æ˜¯å…è´¹ç‰ˆ
        if (apiKeyInput) {
            apiKeyInput.disabled = false;
            apiKeyInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„API Key';
            apiKeyInput.required = true;
            if (apiKeyInput.value === 'free-access') {
                apiKeyInput.value = '';
            }
        }
        if (freeVersionHint) {
            freeVersionHint.style.display = 'none';
        }
        
        // å¯ç”¨è¾…åŠ©APIé€‰æ‹©æ¡†ï¼Œä½†ç¦ç”¨å…è´¹ç‰ˆé€‰é¡¹
        assistApiSelect.disabled = false;
        const freeOption = assistApiSelect.querySelector('option[value="free"]');
        if (freeOption) {
            freeOption.disabled = true;
            freeOption.textContent = 'å…è´¹ç‰ˆï¼ˆä»…æ ¸å¿ƒAPIä¸ºå…è´¹ç‰ˆæ—¶å¯ç”¨ï¼‰';
        }
        
        // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯å…è´¹ç‰ˆï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨èçš„API
        if (selectedAssistApi === 'free') {
            assistApiSelect.value = 'qwen'; // é»˜è®¤åˆ‡æ¢åˆ°é˜¿é‡Œ
        }
        
        switch (selectedCoreApi) {
            case 'qwen':
                recommendation = 'é˜¿é‡Œä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIä¹Ÿé€‰æ‹©é˜¿é‡Œä»¥è·å¾—æœ€ä½³çš„è‡ªå®šä¹‰è¯­éŸ³ä½“éªŒ';
                break;
            case 'glm':
                recommendation = 'æ™ºè°±ä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                break;
            case 'openai':
                recommendation = 'OpenAIä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                break;
            case 'step':
                recommendation = 'é˜¶è·ƒæ˜Ÿè¾°ä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                break;
        }
    }
    
    // æ›´æ–°è¾…åŠ©APIé€‰æ‹©æ¡†çš„æç¤º
    const assistApiTooltip = assistApiSelect.parentElement.querySelector('label .tooltip-content');
    if (assistApiTooltip) {
        assistApiTooltip.innerHTML = `
            <strong>è¾…åŠ©APIè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼š</strong><br>
            â€¢ <strong>é˜¿é‡Œ</strong>ï¼šæ¨èé€‰æ‹©ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³<br>
            â€¢ <strong>æ™ºè°±</strong>ï¼šè®°å¿†ç®¡ç†æ°¸ä¹…å…è´¹ï¼Œæ”¯æŒAgentæ¨¡å¼<br>
            â€¢ <strong>é˜¶è·ƒæ˜Ÿè¾°</strong>ï¼šç›¸å¯¹ä¾¿å®œ<br>
            â€¢ <strong>ç¡…åŸºæµåŠ¨</strong>ï¼šæ€§ä»·æ¯”é«˜<br>
            â€¢ <strong>OpenAI</strong>ï¼šè®°å¿†ç®¡ç†èƒ½åŠ›å¼º<br>
            <strong>æ³¨æ„ï¼š</strong>åªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½<br>
            <strong>å½“å‰å»ºè®®ï¼š</strong>${recommendation}
        `;
    }
}

// BeaconåŠŸèƒ½ - é¡µé¢å…³é—­æ—¶å‘é€ä¿¡å·ç»™æœåŠ¡å™¨ï¼ˆä»…åœ¨ç›´æ¥æ‰“å¼€æ—¶å‘é€ï¼Œiframeä¸­ä¸å‘é€ï¼‰
let beaconSent = false;

function sendBeacon() {
    // å¦‚æœåœ¨iframeä¸­ï¼Œä¸å‘é€beacon
    if (window.parent !== window) {
        return;
    }
    
    if (beaconSent) return; // é˜²æ­¢é‡å¤å‘é€
    beaconSent = true;
    
    try {
        // ä½¿ç”¨navigator.sendBeaconç¡®ä¿ä¿¡å·ä¸è¢«æ‹¦æˆª
        const success = navigator.sendBeacon('/api/beacon/shutdown', JSON.stringify({
            timestamp: Date.now(),
            action: 'shutdown'
        }));
        
        if (success) {
            console.log('Beaconä¿¡å·å·²å‘é€');
        } else {
            console.warn('Beaconå‘é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨fetch');
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
            fetch('/api/beacon/shutdown', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    timestamp: Date.now(),
                    action: 'shutdown'
                }),
                keepalive: true // ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­æ—¶ä»èƒ½å‘é€
            }).catch(err => console.log('å¤‡ç”¨beaconå‘é€å¤±è´¥:', err));
        }
    } catch (e) {
        console.log('Beaconå‘é€å¼‚å¸¸:', e);
    }
}

// ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶ï¼ˆä»…åœ¨ç›´æ¥æ‰“å¼€æ—¶ï¼‰
if (window.parent === window) {
    window.addEventListener('beforeunload', sendBeacon);
    window.addEventListener('unload', sendBeacon);
}

// é¡µé¢åŠ è½½æ—¶å°è¯•è·å–å½“å‰API Key
window.addEventListener('load', function() {
    loadCurrentApiKey();
    
    // æ·»åŠ æ ¸å¿ƒAPIå’Œè¾…åŠ©APIé€‰æ‹©å˜åŒ–çš„äº‹ä»¶ç›‘å¬å™¨
    const coreApiSelect = document.getElementById('coreApiSelect');
    const assistApiSelect = document.getElementById('assistApiSelect');
    
    if (coreApiSelect) {
        coreApiSelect.addEventListener('change', updateAssistApiRecommendation);
    }
    if (assistApiSelect) {
        assistApiSelect.addEventListener('change', updateAssistApiRecommendation);
    }
    
    // åˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡å»ºè®®
    updateAssistApiRecommendation();
});

// å…³é—­API Keyè®¾ç½®é¡µé¢
function closeApiKeySettings() {
    // å¦‚æœåœ¨iframeä¸­ï¼Œé€šçŸ¥çˆ¶é¡µé¢å…³é—­å¼¹çª—
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'close_api_key_settings'
        }, '*');
    } else {
        window.close();
    }
}
</script>
</body>
</html>