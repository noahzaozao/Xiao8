<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²ç®¡ç† - Project Lanlan</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f7f8fa;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 700px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 32px 24px 24px 24px;
        }
        h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .section {
            margin-bottom: 32px;
        }
        .field-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .field-row label {
            min-width: 80px;
            font-weight: bold;
        }
        .field-row input, .field-row select {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .field-row .optional {
            color: #888;
            font-size: 0.95em;
            margin-left: 8px;
        }
        .btn {
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            background: #4f8cff;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 8px;
            transition: background 0.2s;
        }
        .btn:active { background: #2662c8; }
        .btn.delete { background: #e74c3c; }
        .btn.delete:active { background: #c0392b; }
        .btn.add { background: #27ae60; }
        .btn.add:active { background: #1e8449; }
        /* å°å·æŒ‰é’® */
        .btn.sm {
            padding: 4px 10px;
            font-size: 0.92rem;
            border-radius: 4px;
            margin-right: 4px;
        }
        .btn.sm.delete { background: #e74c3c; }
        .btn.sm.add { background: #27ae60; }
        .btn.sm:active { background: #2662c8; }
        .btn.sm.delete:active { background: #c0392b; }
        .btn.sm.add:active { background: #1e8449; }
        .fold {
            background: #f0f2f5;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px 16px;
        }
        .fold-toggle {
            cursor: pointer;
            color: #4f8cff;
            font-weight: bold;
            user-select: none;
        }
        .fold-content {
            display: none;
            margin-top: 10px;
        }
        .fold.open > .fold-content {
            display: block;
        }
        .catgirl-block {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 16px 12px 10px 12px;
            background: #fafbfc;
        }
        .catgirl-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .catgirl-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        .catgirl-actions {
            display: flex;
            gap: 8px;
        }
        .tips {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .container { padding: 10px 2vw; }
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">è§’è‰²ç®¡ç†</h2>
        <button class="btn sm" onclick="openApiKeySettings()" style="background: #6c757d;">ğŸ”‘ API Key è®¾ç½®</button>
    </div>
    <div class="section" id="master-section">
        <div class="tips">ğŸ·ä¸»äººæ¡£æ¡ˆï¼ˆå”¯ä¸€ï¼‰ï¼šæ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹ï¼Œå…¶ä»–å‡ä¸ºå¯é€‰é¡¹ï¼Œå¯è‡ªè¡Œåˆ å‡ã€‚</div>
        <div class="catgirl-block">
            <form id="master-form">
                <div class="field-row">
                    <label>æ¡£æ¡ˆå<span style="color:red">*</span></label>
                    <input type="text" name="æ¡£æ¡ˆå" required>
                </div>
                <div class="field-row">
                    <label>æ€§åˆ«</label>
                    <input type="text" name="æ€§åˆ«">
                    <button type="button" class="btn sm delete" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>
                </div>
                <div class="field-row">
                    <label>æ˜µç§°</label>
                    <input type="text" name="æ˜µç§°">
                    <button type="button" class="btn sm delete" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>
                </div>
            </form>
        </div>
    </div>
    <div class="section" id="catgirl-section">
        <div class="tips">ğŸ©·çŒ«å¨˜æ¡£æ¡ˆï¼šè¿›é˜¶è®¾å®šåŒ…å«Live2Då½¢è±¡ã€è¯­éŸ³IDç­‰ã€‚</div>
        <div id="catgirl-list"></div>
        <!-- <button class="btn add sm" id="add-catgirl-btn">â• æ–°å¢çŒ«å¨˜</button> -->
    </div>
</div>
<script>
// æŠ˜å é¢æ¿åˆ‡æ¢
function toggleFold(fold) {
    fold.classList.toggle('open');
}

// äº‹ä»¶å§”æ‰˜ï¼Œæ”¯æŒæ‰€æœ‰åŠ¨æ€è¡¨å•çš„æŠ˜å æŒ‰é’®å’Œç®­å¤´ç¬¦å·
if (!window._charaManagerFoldHandler) {
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('fold-toggle') || (e.target.classList.contains('arrow') && e.target.parentNode.classList.contains('fold-toggle'))) {
            let toggle = e.target.classList.contains('fold-toggle') ? e.target : e.target.parentNode;
            let fold = toggle.closest('.fold');
            if (fold) {
                fold.classList.toggle('open');
                // åŠ¨æ€åˆ‡æ¢ç®­å¤´
                let arrow = toggle.querySelector('.arrow');
                if (arrow) arrow.textContent = fold.classList.contains('open') ? 'â–²' : 'â–¼';
            }
        }
    });
    window._charaManagerFoldHandler = true;
}

// è§’è‰²æ•°æ®ç¼“å­˜
let characterData = null;

// åŠ è½½è§’è‰²æ•°æ®
async function loadCharacterData() {
    const resp = await fetch('/api/characters');
    characterData = await resp.json();
    renderMaster();
    renderCatgirls();
}

// æ¸²æŸ“ä¸»äººè¡¨å•
function renderMaster() {
    const master = characterData['ä¸»äºº'] || {};
    const form = document.getElementById('master-form');
    // æ¸…ç©ºåŸæœ‰è‡ªå®šä¹‰é¡¹
    Array.from(form.querySelectorAll('.custom-row')).forEach(e => e.remove());
    form.æ¡£æ¡ˆå.value = master['æ¡£æ¡ˆå'] || '';
    form.æ€§åˆ«.value = master['æ€§åˆ«'] || '';
    form.æ˜µç§°.value = master['æ˜µç§°'] || '';
    // æ¸²æŸ“è‡ªå®šä¹‰é¡¹
    Object.keys(master).forEach(k => {
        if (["æ¡£æ¡ˆå", "æ€§åˆ«", "æ˜µç§°"].includes(k)) return;
        const row = document.createElement('div');
        row.className = 'field-row custom-row';
        row.innerHTML = `<label>${k}</label><input type="text" name="${k}" value="${master[k]}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>`;
        form.insertBefore(row, form.querySelector('div[style]'));
    });
}

// æ–°å¢ä¸»äººè‡ªå®šä¹‰è®¾å®š
if (!window._addMasterFieldHandler) {
    var masterFormEl = document.getElementById('master-form');
    if (masterFormEl) {
        masterFormEl.insertAdjacentHTML('beforeend', '<div style="text-align:right;margin-top:8px"><button type="button" class="btn sm add" id="add-master-field-btn">æ–°å¢è®¾å®š</button><button type="submit" class="btn sm">ä¿å­˜ä¸»äººè®¾å®š</button></div>');
    }
    document.getElementById('add-master-field-btn') && (document.getElementById('add-master-field-btn').onclick = function() {
        const key = prompt('è¯·è¾“å…¥æ–°è®¾å®šçš„åç§°ï¼ˆé”®åï¼‰');
        if (!key || ["æ¡£æ¡ˆå"].includes(key)) return;
        if (document.querySelector(`[name='${key}']`)) { alert('è¯¥è®¾å®šå·²å­˜åœ¨'); return; }
        const row = document.createElement('div');
        row.className = 'field-row custom-row';
        row.innerHTML = `<label>${key}</label><input type="text" name="${key}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>`;
        masterFormEl.insertBefore(row, masterFormEl.querySelector('div[style]'));
    });
    window._addMasterFieldHandler = true;
}
window.deleteMasterField = function(btn) {
    const row = btn.parentNode;
    // æ¡£æ¡ˆåä¸èƒ½åˆ 
    if (row.querySelector('label') && row.querySelector('label').textContent === 'æ¡£æ¡ˆå') return;
    row.remove();
};

// ä¿å­˜ä¸»äºº
const masterForm = document.getElementById('master-form');
masterForm.onsubmit = async function(e) {
    e.preventDefault();
    const data = {};
    for (const [k, v] of new FormData(masterForm).entries()) {
        if (k && v) data[k] = v;
    }
    if (!data['æ¡£æ¡ˆå']) {
        alert('æ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹');
        return;
    }
    await fetch('/api/characters/master', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    await loadCharacterData();
};

// æ¸²æŸ“çŒ«å¨˜åˆ—è¡¨
function renderCatgirls() {
    const list = document.getElementById('catgirl-list');
    list.innerHTML = '';
    const catgirls = characterData['çŒ«å¨˜'] || {};
    Object.keys(catgirls).forEach(key => {
        const cat = catgirls[key];
        // éšæœºé¢œè‰²
        const color = randomColor();
        const block = document.createElement('div');
        block.className = 'catgirl-block';
        block.innerHTML = `
            <div class="catgirl-header">
                <span class="catgirl-expand" style="cursor:pointer;font-size:1.2em;margin-right:6px;user-select:none">â–¶</span>
                <span class="catgirl-title" style="color:${color};">${key}</span>
                <div class="catgirl-actions">
                    <button class="btn sm delete" onclick="deleteCatgirl('${key}')">åˆ é™¤çŒ«å¨˜</button>
                </div>
            </div>
            <div class="catgirl-details" style="display:none;"></div>
        `;
        // å±•å¼€æŒ‰é’®é€»è¾‘
        const expandBtn = block.querySelector('.catgirl-expand');
        const detailsDiv = block.querySelector('.catgirl-details');
        expandBtn.onclick = function() {
            const isOpen = detailsDiv.style.display === '' || detailsDiv.style.display === 'block';
            if (isOpen) {
                detailsDiv.style.display = 'none';
                expandBtn.textContent = 'â–¶';
                detailsDiv.innerHTML = '';
            } else {
                detailsDiv.style.display = 'block';
                expandBtn.textContent = 'â–¼';
                showCatgirlForm(key, detailsDiv);
            }
        };
        list.appendChild(block);
    });
}

// éšæœºé¢œè‰²å‡½æ•°
function randomColor() {
    // ç”Ÿæˆæ˜äº®ã€æŸ”å’Œçš„éšæœºè‰²
    const h = Math.floor(Math.random() * 360);
    const s = 60 + Math.floor(Math.random() * 25); // 60-85%
    const l = 45 + Math.floor(Math.random() * 30); // 45-75%
    return `hsl(${h},${s}%,${l}%)`;
}

// // æ–°å¢çŒ«å¨˜
// const addBtn = document.getElementById('add-catgirl-btn');
// addBtn.onclick = function() {
//     showCatgirlForm(null);
// };

// ç¼–è¾‘çŒ«å¨˜
window.editCatgirl = function(key) {
    showCatgirlForm(key);
};

// åˆ é™¤çŒ«å¨˜
window.deleteCatgirl = async function(key) {
    const catgirls = characterData['çŒ«å¨˜'] || {};
    if (Object.keys(catgirls).length <= 1) {
        alert('åªå‰©ä¸€åªçŒ«å¨˜ï¼Œæ— æ³•åˆ é™¤ï¼');
        return;
    }
    if (!confirm('ç¡®å®šè¦åˆ é™¤çŒ«å¨˜"' + key + '"ï¼Ÿ')) return;
    await fetch('/api/characters/catgirl/' + encodeURIComponent(key), {method: 'DELETE'});
    await loadCharacterData();
};

// æ˜¾ç¤ºçŒ«å¨˜ç¼–è¾‘/æ–°å¢è¡¨å•
function showCatgirlForm(key, container) {
    let cat = key ? characterData['çŒ«å¨˜'][key] : {};
    let isNew = !key;
    let form = document.createElement('form');
    form.id = key ? 'catgirl-form-' + key : 'catgirl-form-new';
    // å…ˆæ¸²æŸ“åŸºç¡€é¡¹
    form.innerHTML = `
        <div class="field-row">
            <label>æ¡£æ¡ˆå<span style="color:red">*</span></label>
            <input type="text" name="æ¡£æ¡ˆå" value="${key || ''}" ${isNew ? '' : 'readonly'} required>
            ${!isNew ? '<button type="button" class="btn sm" id="rename-catgirl-btn">ä¿®æ”¹åç§°</button>' : ''}
        </div>
    `;
    // æ¸²æŸ“è‡ªå®šä¹‰é¡¹
    Object.keys(cat).forEach(k => {
        if (!["live2d", "voice_id", "system_prompt", "æ¡£æ¡ˆå"].includes(k)) {
            const row = document.createElement('div');
            row.className = 'field-row custom-row';
            row.innerHTML = `<label>${k}</label><input type="text" name="${k}" value="${cat[k]}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteCatgirlField(this)">åˆ é™¤è®¾å®š</button>`;
            form.appendChild(row);
        }
    });
    // æ¸²æŸ“è¿›é˜¶è®¾å®š
    form.innerHTML += `
        <div class="fold">
            <div class="fold-toggle">è¿›é˜¶è®¾å®š <span class="arrow">â–¼</span></div>
            <div class="fold-content">
                <div class="field-row">
                    <label>live2d</label>
                    <span class="live2d-link" style="flex:1;cursor:pointer;color:#4f8cff;text-decoration:underline;display:inline-block;padding:6px 0" title="ç‚¹å‡»ç®¡ç†Live2Dæ¨¡å‹">${cat['live2d'] ? cat['live2d'] : 'æœªè®¾ç½®'}</span>
                </div>
                <div class="field-row">
                    <label>voice_id</label>
                    <span>${cat['voice_id'] ? cat['voice_id'] : 'æœªæ³¨å†Œ'}</span>
                    <button type="button" class="btn sm" onclick="openVoiceClone('${key || ''}')">æ³¨å†Œå£°éŸ³</button>
                </div>
                <div class="fold">
                    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 8px 0;">
                    <div class="fold-toggle" style="color: #888; font-style: italic">system_prompt <span class="arrow">â–¼</span></div>
                    <div class="fold-content">
                        <textarea name="system_prompt" rows="5" style="width:100%" placeholder="ç³»ç»ŸæŒ‡ä»¤ï¼ˆè°¨æ…ä¿®æ”¹ï¼‰">${cat['system_prompt'] || ''}</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align:right;margin-top:10px;">
            <button type="button" class="btn sm add" id="add-catgirl-field-btn">æ–°å¢è®¾å®š</button>
            <button type="submit" class="btn sm">${isNew ? 'æ–°å¢çŒ«å¨˜' : 'ä¿å­˜ä¿®æ”¹'}</button>
            <button type="button" class="btn sm" onclick="loadCharacterData()">å–æ¶ˆ</button>
        </div>
    `;
    // live2då¼¹çª—é€»è¾‘
    const live2dLink = form.querySelector('.live2d-link');
    if (live2dLink) {
        live2dLink.onclick = function() {
            const catgirlName = form.querySelector('[name="æ¡£æ¡ˆå"]').value;
            const popup = window.open(
                `/l2d?lanlan_name=${encodeURIComponent(catgirlName)}`,
                '_blank',
                'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=' + screen.availWidth + ',height=' + screen.availHeight + ',top=0,left=0'
            );
            if (!popup) return alert('è¯·å…è®¸å¼¹çª—ï¼');
            popup.moveTo(0, 0);
            popup.resizeTo(screen.availWidth, screen.availHeight);
            const timer = setInterval(() => {
                if (popup.closed) {
                    clearInterval(timer);
                    loadCharacterData();
                }
            }, 500);
        };
    }
    // æ–°å¢è‡ªå®šä¹‰é¡¹æŒ‰é’®
    form.querySelector('#add-catgirl-field-btn').onclick = function() {
        const key = prompt('è¯·è¾“å…¥æ–°è®¾å®šçš„åç§°ï¼ˆé”®åï¼‰');
        if (!key || ["æ¡£æ¡ˆå", "live2d", "voice_id", "system_prompt"].includes(key)) return;
        if (form.querySelector(`[name='${key}']`)) { alert('è¯¥è®¾å®šå·²å­˜åœ¨'); return; }
        const row = document.createElement('div');
        row.className = 'field-row custom-row';
        row.innerHTML = `<label>${key}</label><input type="text" name="${key}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteCatgirlField(this)">åˆ é™¤è®¾å®š</button>`;
        form.insertBefore(row, form.querySelector('.fold'));
    };
    form.onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(form);
        const data = {};
        for (const [k, v] of fd.entries()) {
            if (k && v) data[k] = v;
        }
        if (!data['æ¡£æ¡ˆå']) { alert('æ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹'); return; }
        await fetch('/api/characters/catgirl' + (isNew ? '' : '/' + encodeURIComponent(key)), {
            method: isNew ? 'POST' : 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        await loadCharacterData();
    };
    // ç»‘å®š"ä¿®æ”¹åç§°"æŒ‰é’®äº‹ä»¶
    if (!isNew) {
        const renameBtn = form.querySelector('#rename-catgirl-btn');
        if (renameBtn) {
            renameBtn.onclick = async function() {
                await window.renameCatgirl(key);
            };
        }
    }
    // æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨
    if (container) {
        container.innerHTML = '';
        container.appendChild(form);
    } else {
        // å…¼å®¹åŸæœ‰é€»è¾‘
        const list = document.getElementById('catgirl-list');
        // å…ˆç§»é™¤æ‰€æœ‰è¡¨å•
        Array.from(list.querySelectorAll('form')).forEach(f => f.style.display = 'none');
        // æ‰¾åˆ°æˆ–æ–°å»ºè¡¨å•
        if (key) {
            let oldForm = document.getElementById('catgirl-form-' + key);
            if (oldForm) oldForm.style.display = '';
        } else {
            const block = document.createElement('div');
            block.className = 'catgirl-block';
            block.innerHTML = `<form id="catgirl-form-new"></form>`;
            list.prepend(block);
            block.querySelector('form').replaceWith(form);
        }
    }
}
window.deleteCatgirlField = function(btn) {
    btn.parentNode.remove();
};

// çŒ«å¨˜æ¡£æ¡ˆåé‡å‘½å
window.renameCatgirl = async function(oldName) {
    const newName = prompt('è¯·è¾“å…¥æ–°çš„çŒ«å¨˜æ¡£æ¡ˆå', oldName);
    if (!newName || newName === oldName) return;
    if (characterData['çŒ«å¨˜'][newName]) { alert('è¯¥æ¡£æ¡ˆåå·²å­˜åœ¨'); return; }
    // è°ƒç”¨APIé‡å‘½å
    const res = await fetch('/api/characters/catgirl/' + encodeURIComponent(oldName) + '/rename', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({new_name: newName})
    });
    const result = await res.json();
    if (result.success) {
        await loadCharacterData();
    } else {
        alert(result.error || 'é‡å‘½åå¤±è´¥');
    }
}

function openApiKeySettings() {
    // åˆ›å»ºå¼¹çª—å®¹å™¨
    let modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.4)';
    modal.style.zIndex = '9999';
    modal.onclick = function(e) { if (e.target === modal) document.body.removeChild(modal); };
    // åˆ›å»ºiframe
    let iframe = document.createElement('iframe');
    iframe.src = '/api_key';
    iframe.style.width = '600px';
    iframe.style.height = '650px';
    iframe.style.border = 'none';
    iframe.style.background = '#fff';
    iframe.style.display = 'block';
    iframe.style.margin = '50px auto';
    iframe.style.borderRadius = '8px';
    // ç›‘å¬å…³é—­æ¶ˆæ¯
    window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'close_api_key_settings') {
            document.body.removeChild(modal);
            window.removeEventListener('message', handler);
        }
    });
    modal.appendChild(iframe);
    document.body.appendChild(modal);
}

function openVoiceClone(lanlanName) {
    // åˆ›å»ºå¼¹çª—å®¹å™¨
    let modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.4)';
    modal.style.zIndex = '9999';
    modal.onclick = function(e) { if (e.target === modal) document.body.removeChild(modal); };
    // åˆ›å»ºiframe
    let iframe = document.createElement('iframe');
    iframe.src = '/voice_clone?lanlan_name=' + encodeURIComponent(lanlanName);
    iframe.style.width = '600px';
    iframe.style.height = '400px';
    iframe.style.border = 'none';
    iframe.style.background = '#fff';
    iframe.style.display = 'block';
    iframe.style.margin = '60px auto';
    iframe.style.borderRadius = '8px';
    // ç›‘å¬voice_idå˜æ›´ï¼Œæ³¨å†Œé¡µé¢å¯åœ¨window.parent.postMessageé€šçŸ¥
    window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'voice_id_updated') {
            document.body.removeChild(modal);
            window.removeEventListener('message', handler);
            loadCharacterData();
        }
    });
    modal.appendChild(iframe);
    document.body.appendChild(modal);
}

// BeaconåŠŸèƒ½ - é¡µé¢å…³é—­æ—¶å‘é€ä¿¡å·ç»™æœåŠ¡å™¨
let beaconSent = false;

function sendBeacon() {
    if (beaconSent) return; // é˜²æ­¢é‡å¤å‘é€
    beaconSent = true;
    
    try {
        // ä½¿ç”¨navigator.sendBeaconç¡®ä¿ä¿¡å·ä¸è¢«æ‹¦æˆª
        const success = navigator.sendBeacon('/api/beacon/shutdown', JSON.stringify({
            timestamp: Date.now(),
            action: 'shutdown'
        }));
        
        if (success) {
            console.log('Beaconä¿¡å·å·²å‘é€');
        } else {
            console.warn('Beaconå‘é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨fetch');
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
            fetch('/api/beacon/shutdown', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    timestamp: Date.now(),
                    action: 'shutdown'
                }),
                keepalive: true // ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­æ—¶ä»èƒ½å‘é€
            }).catch(err => console.log('å¤‡ç”¨beaconå‘é€å¤±è´¥:', err));
        }
    } catch (e) {
        console.log('Beaconå‘é€å¼‚å¸¸:', e);
    }
}

// ç›‘å¬API Keyå˜æ›´äº‹ä»¶
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'api_key_changed') {
        // API Keyå·²æ›´æ”¹ï¼Œåˆ·æ–°è§’è‰²æ•°æ®ä»¥æ˜¾ç¤ºæ›´æ–°åçš„Voice IDçŠ¶æ€
        console.log('API Keyå·²æ›´æ”¹ï¼Œæ­£åœ¨åˆ·æ–°è§’è‰²æ•°æ®...');
        loadCharacterData();
    }
});

// ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
window.addEventListener('beforeunload', sendBeacon);
window.addEventListener('unload', sendBeacon);

// é¡µé¢åŠ è½½æ—¶æ‹‰å–æ•°æ®
loadCharacterData();

// ä¸»äººä¿å­˜æŒ‰é’®ä¹Ÿç”¨.btn.sm
const masterSaveBtn = document.querySelector('#master-form button[type="submit"]');
if (masterSaveBtn) masterSaveBtn.classList.add('sm');
</script>
</body>
</html> 