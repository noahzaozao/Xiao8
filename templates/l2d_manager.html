<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D æ¨¡å‹ç®¡ç†å™¨</title>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; background: #eee; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: auto;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            min-width: 280px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .control-select, .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
        }
        .btn {
            color: white;
            border: none;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-primary { background: #667eea; }
        .btn-primary:hover:not(:disabled) { background: #5a6fd8; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .btn-success { background: #28a745; }
        .btn-success:hover:not(:disabled) { background: #218838; }

        .action-group {
            display: flex;
            gap: 10px;
        }
        .action-group .control-select {
            flex-grow: 1;
        }
        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
        #chat-container-placeholder { 
            pointer-events: auto; 
            position: fixed; 
            left: 20px; 
            bottom: 20px; 
            width: 340px;
            height: 300px; 
            background: rgba(247, 248, 250, 0.7);
            border-radius: 12px; 
            padding: 16px;
            box-sizing: border-box; 
            z-index: 20; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; 
            flex-direction: column; 
            backdrop-filter: blur(10px);
        }
        #chat-content-wrapper { 
            flex-grow: 1; 
            padding-left: 8px; 
            overflow-y: auto; 
            opacity: 0.7; 
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="control-group">
        <button id="fullscreenBtn" class="btn btn-secondary">ğŸ–¥ï¸ å…¨å±</button>
        <button id="exitFullscreenBtn" class="btn btn-secondary" style="display:none;">âŒ é€€å‡ºå…¨å±</button>
    </div>
    <div class="control-group">
        <label for="model-select" class="control-label">é€‰æ‹©æ¨¡å‹:</label>
        <select id="model-select" class="control-select">
            <option>åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div class="control-group">
        <label class="control-label">åŠ¨ä½œé¢„è§ˆ:</label>
        <div class="action-group">
            <select id="motion-select" class="control-select" disabled>
                <option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-motion-btn" class="btn btn-primary" disabled>æ’­æ”¾</button>
        </div>
    </div>
    
    <div class="control-group">
        <label class="control-label">è¡¨æƒ…é¢„è§ˆ:</label>
        <div class="action-group">
            <select id="expression-select" class="control-select" disabled>
                <option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-expression-btn" class="btn btn-primary" disabled>æ’­æ”¾</button>
        </div>
    </div>

    <div class="control-group">
        <div style="display:flex; gap: 10px;">
            <button id="emotion-manager-btn" class="btn btn-secondary" disabled style="flex:1;">âš™ï¸ æƒ…æ„Ÿé…ç½®</button>
            <button id="save-position-btn" class="btn btn-success" disabled style="flex:1;">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <div class="control-group" id="persistent-box" style="display:none;">
        <label class="control-label">å¸¸é©»è¡¨æƒ…ï¼ˆä»…expressionï¼‰:</label>
        <div class="action-group">
            <select id="persistent-expression-select" class="control-select" disabled>
                <option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="add-persistent-btn" class="btn btn-primary" disabled>æ·»åŠ </button>
        </div>
        <div id="persistent-list" style="margin-top:6px; max-height:120px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:6px; background:#fff;"></div>
        <button id="save-persistent-btn" class="btn btn-success" disabled style="margin-top:6px;">ä¿å­˜å¸¸é©»è¡¨æƒ…</button>
        <div style="font-size:12px; color:#666;">å¸¸é©»è¡¨æƒ…ä¼šä¸€ç›´ç”Ÿæ•ˆï¼Œä¸ä¼šè¢«æ¸…é™¤æˆ–è¦†ç›–ï¼›æ­¤å¤„ä»…èƒ½é€‰æ‹© .exp3.jsonã€‚</div>
    </div>
    
    <div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
</div>

<div id="chat-container-placeholder">
    <div id="chat-content-wrapper"><p style="color: #888">å¯¹è¯å†å²ç•Œé¢<br><br>...ç°åœ¨æ˜¯ä¸€ç‰‡ç©ºç™½...</p></div>
</div>

<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>
<script src="/static/libs/live2d.min.js"></script>
<script src="/static/libs/pixi.min.js"></script>
<script src="/static/libs/index.min.js"></script>
<script src="/static/live2d.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const statusDiv = document.getElementById('status');
        const modelSelect = document.getElementById('model-select');
        const motionSelect = document.getElementById('motion-select');
        const expressionSelect = document.getElementById('expression-select');
        const playMotionBtn = document.getElementById('play-motion-btn');
        const playExpressionBtn = document.getElementById('play-expression-btn');
        const emotionManagerBtn = document.getElementById('emotion-manager-btn');
        const savePositionBtn = document.getElementById('save-position-btn');
        const persistentBox = document.getElementById('persistent-box');
        const persistentSelect = document.getElementById('persistent-expression-select');
        const addPersistentBtn = document.getElementById('add-persistent-btn');
        const persistentList = document.getElementById('persistent-list');
        const savePersistentBtn = document.getElementById('save-persistent-btn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');

        let currentModelInfo = null;
        let availableModels = [];
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let live2dModel = null;
        let currentEmotionMapping = null; // { motions: {...}, expressions: {...} }
        let currentPersistent = []; // expressions.å¸¸é©»

        const showStatus = (msg, duration = 0) => {
            statusDiv.textContent = msg;
            if (duration > 0) {
                setTimeout(() => {
                    if (currentModelInfo) {
                        showStatus(`å½“å‰æ¨¡å‹: ${currentModelInfo.name}`);
                    }
                }, duration);
            }
        };

        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
        showStatus('PIXI åˆå§‹åŒ–å®Œæˆ');

        // åŠ è½½å½“å‰è§’è‰²çš„æ¨¡å‹
        await loadCurrentCharacterModel();

        try {
            const response = await fetch('/api/live2d/models');
            availableModels = await response.json();
            if (availableModels.length > 0) {
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹</option>';
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
                showStatus('æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ');
            } else {
                showStatus('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹');
            }
        } catch (e) {
            showStatus('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
        }

        // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²çš„å‡½æ•°
        async function saveModelToCharacter(modelName) {
            try {
                // ä»URLå‚æ•°ä¸­è·å–è§’è‰²åç§°
                const urlParams = new URLSearchParams(window.location.search);
                const lanlanName = urlParams.get('lanlan_name') || '';
                
                if (!lanlanName) {
                    showStatus('æ— æ³•ä¿å­˜ï¼šæœªæŒ‡å®šè§’è‰²åç§°');
                    return false;
                }
                
                const response = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(lanlanName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ live2d: modelName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`å·²ä¿å­˜æ¨¡å‹è®¾ç½®: ${lanlanName} -> ${modelName}`, 2000);
                    return true;
                } else {
                    showStatus(`ä¿å­˜å¤±è´¥: ${result.error}`, 3000);
                    return false;
                }
            } catch (error) {
                console.error('ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥:', error);
                showStatus('ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥', 3000);
                return false;
            }
        }

        // ä¿®æ”¹æ¨¡å‹é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®
        modelSelect.addEventListener('change', async (e) => {
            const modelName = e.target.value;
            if (!modelName) return;

            currentModelInfo = availableModels.find(m => m.name === modelName);
            if (!currentModelInfo) return;

            await loadModel(modelName, currentModelInfo);
            
            // è‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²
            await saveModelToCharacter(modelName);
        });

        // åŠ è½½æ¨¡å‹çš„å‡½æ•°
        async function loadModel(modelName, modelInfo) {
            if (!modelName || !modelInfo) return;
            
            showStatus(`æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelName}...`);
            setControlsDisabled(true);

            try {
                // 1. Fetch files list
                const filesRes = await fetch(`/api/live2d/model_files/${modelName}`);
                const filesData = await filesRes.json();
                if (!filesData.success) throw new Error('æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶åˆ—è¡¨');
                currentModelFiles = filesData;

                // 2. Fetch model config
                const modelJsonUrl = modelInfo.path;
                const modelConfigRes = await fetch(modelJsonUrl);
                if (!modelConfigRes.ok) throw new Error(`æ— æ³•è·å–æ¨¡å‹é…ç½®: ${modelConfigRes.statusText}`);
                const modelConfig = await modelConfigRes.json();
                
                // 3. Add URL context for the loader
                modelConfig.url = modelJsonUrl;

                // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                // Motions
                if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                // åªæœ‰å½“æ¨¡å‹æœ‰åŠ¨ä½œæ–‡ä»¶æ—¶æ‰æ·»åŠ PreviewAllç»„
                if (currentModelFiles.motion_files.length > 0) {
                    modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                        File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                    }));
                }

                // Expressions: Overwrite with all available expression files for preview purposes.
                modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                    Name: file.split('/').pop().replace('.exp3.json', ''),  // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åä½œä¸ºåç§°
                    File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                }));
                
                // 5. Load preferences
                const preferences = await window.live2dManager.loadUserPreferences();
                console.log('åŠ è½½çš„åå¥½è®¾ç½®:', preferences);
                console.log('å½“å‰æ¨¡å‹è·¯å¾„:', modelInfo.path);
                const modelPreferences = preferences.find(p => p && p.model_path === modelInfo.path) || null;
                console.log('åŒ¹é…çš„æ¨¡å‹åå¥½:', modelPreferences);

                // 6. Load model FROM THE MODIFIED OBJECT
                await window.live2dManager.loadModel(modelConfig, {
                    loadEmotionMapping: true,
                    dragEnabled: true,
                    wheelEnabled: true,
                    preferences: modelPreferences
                });
                live2dModel = window.live2dManager.getCurrentModel();

                updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, 'é€‰æ‹©åŠ¨ä½œ');
                updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, 'é€‰æ‹©è¡¨æƒ…');

                // 7. Load current emotion mapping for this model
                await loadEmotionMappingForModel(modelName);
                renderPersistentUI();
                
                // å¦‚æœæ²¡æœ‰åŠ¨ä½œæ–‡ä»¶ï¼Œç¦ç”¨åŠ¨ä½œç›¸å…³æ§ä»¶
                if (currentModelFiles.motion_files.length === 0) {
                    motionSelect.disabled = true;
                    playMotionBtn.disabled = true;
                    motionSelect.innerHTML = '<option value="">è¯¥æ¨¡å‹æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶</option>';
                }
                setControlsDisabled(false);
                showStatus(`æ¨¡å‹ ${modelName} åŠ è½½æˆåŠŸ`);

            } catch (error) {
                showStatus(`åŠ è½½æ¨¡å‹ ${modelName} å¤±è´¥`);
                console.error(error);
                setControlsDisabled(false);
            }
        }

        playMotionBtn.addEventListener('click', () => {
            if (!live2dModel || !motionSelect.value) return;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ä½œæ–‡ä»¶
            if (currentModelFiles.motion_files.length === 0) {
                showStatus('è¯¥æ¨¡å‹æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶', 2000);
                return;
            }
            
            const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
            if (motionIndex > -1) {
                try {
                    live2dModel.motion('PreviewAll', motionIndex, 3);
                    showStatus(`æ’­æ”¾åŠ¨ä½œ: ${motionSelect.value}`, 1000);
                } catch (error) {
                    console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                    showStatus(`æ’­æ”¾åŠ¨ä½œå¤±è´¥: ${motionSelect.value}`, 2000);
                }
            } else {
                showStatus('åŠ¨ä½œæ–‡ä»¶ä¸å­˜åœ¨', 2000);
            }
        });

        playExpressionBtn.addEventListener('click', () => {
            if (!live2dModel || !expressionSelect.value) return;
            // ä»å®Œæ•´è·¯å¾„ä¸­æå–è¡¨æƒ…åç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
            const expressionName = expressionSelect.value.split('/').pop().replace('.exp3.json', '');
            console.log('æ’­æ”¾è¡¨æƒ…:', expressionName); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            try {
                live2dModel.expression(expressionName);
                showStatus(`æ’­æ”¾è¡¨æƒ…: ${expressionName}`, 1000);
            } catch (error) {
                console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                showStatus(`æ’­æ”¾è¡¨æƒ…å¤±è´¥: ${expressionName}`, 2000);
            }
        });

        emotionManagerBtn.addEventListener('click', () => {
            if (!currentModelInfo) return;
            openModal('/live2d_emotion_manager');
        });

        savePositionBtn.addEventListener('click', async () => {
            if (!currentModelInfo || !live2dModel) return;
            showStatus('æ­£åœ¨ä¿å­˜è®¾ç½®...');
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('ä¿å­˜è®¾ç½® - æ¨¡å‹è·¯å¾„:', currentModelInfo.path);
            console.log('ä¿å­˜è®¾ç½® - å½“å‰ä½ç½®:', { x: live2dModel.x, y: live2dModel.y });
            console.log('ä¿å­˜è®¾ç½® - å½“å‰ç¼©æ”¾:', { x: live2dModel.scale.x, y: live2dModel.scale.y });
            
            // ä¿å­˜ä½ç½®å’Œç¼©æ”¾
            const positionSuccess = await window.live2dManager.saveUserPreferences(
                currentModelInfo.path,
                { x: live2dModel.x, y: live2dModel.y },
                { x: live2dModel.scale.x, y: live2dModel.scale.y }
            );
            
            // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²
            const modelSuccess = await saveModelToCharacter(currentModelInfo.name);
            
            if (positionSuccess && modelSuccess) {
                showStatus('ä½ç½®å’Œæ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ!', 2000);
            } else if (positionSuccess) {
                showStatus('ä½ç½®ä¿å­˜æˆåŠŸï¼Œæ¨¡å‹è®¾ç½®ä¿å­˜å¤±è´¥!', 2000);
            } else if (modelSuccess) {
                showStatus('æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸï¼Œä½ç½®ä¿å­˜å¤±è´¥!', 2000);
            } else {
                showStatus('ä¿å­˜å¤±è´¥!', 2000);
            }
        });
        
        // Fullscreen logic
        fullscreenBtn.onclick = () => document.documentElement.requestFullscreen?.();
        exitFullscreenBtn.onclick = () => document.exitFullscreen?.();
        const updateFullscreenButtons = () => {
            const isFullscreen = !!document.fullscreenElement;
            fullscreenBtn.style.display = isFullscreen ? 'none' : '';
            exitFullscreenBtn.style.display = isFullscreen ? '' : 'none';
        };
        document.addEventListener('fullscreenchange', updateFullscreenButtons);
        updateFullscreenButtons();

        // Helper functions
        function setControlsDisabled(disabled) {
            motionSelect.disabled = disabled;
            expressionSelect.disabled = disabled;
            playMotionBtn.disabled = disabled;
            playExpressionBtn.disabled = disabled;
            emotionManagerBtn.disabled = disabled;
            savePositionBtn.disabled = disabled;
            persistentSelect.disabled = disabled;
            addPersistentBtn.disabled = disabled;
            savePersistentBtn.disabled = disabled;
        }

        function updateSelectWithOptions(select, options, defaultText) {
            select.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                // ä¸ºè¡¨æƒ…æ–‡ä»¶æä¾›æ›´å‹å¥½çš„æ˜¾ç¤ºåç§°
                if (defaultText.includes('è¡¨æƒ…')) {
                    const displayName = opt.split('/').pop().replace('.exp3.json', '');
                    option.textContent = displayName;
                } else if (defaultText.includes('åŠ¨ä½œ')) {
                    // ä¸ºåŠ¨ä½œæ–‡ä»¶æä¾›æ›´å‹å¥½çš„æ˜¾ç¤ºåç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
                    const displayName = opt.split('/').pop().replace('.motion3.json', '');
                    option.textContent = displayName;
                } else {
                    option.textContent = opt;
                }
                select.appendChild(option);
            });
        }

        function openModal(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

            const header = document.createElement('div');
            header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;
            
            const title = document.createElement('h3');
            title.textContent = 'æƒ…æ„Ÿé…ç½®ç®¡ç†å™¨';
            title.style.cssText = 'margin: 0;';

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Ã—';
            closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

            const closeModal = () => {
                modal.remove();
                if (currentModelInfo) {
                    modelSelect.value = currentModelInfo.name;
                    modelSelect.dispatchEvent(new Event('change'));
                }
            };
            
            closeButton.onclick = closeModal;
            header.appendChild(title);
            header.appendChild(closeButton);
            iframeContainer.appendChild(header);
            iframeContainer.appendChild(iframe);
            modal.appendChild(iframeContainer);
            document.body.appendChild(modal);
        }

        // ===== å¸¸é©»è¡¨æƒ… ç®¡ç† =====
        async function loadEmotionMappingForModel(modelName) {
            currentEmotionMapping = null;
            currentPersistent = [];
            try {
                const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(modelName)}`);
                const data = await res.json();
                if (data && data.success && data.config) {
                    currentEmotionMapping = data.config;
                } else {
                    currentEmotionMapping = { motions: {}, expressions: {} };
                }
            } catch (e) {
                currentEmotionMapping = { motions: {}, expressions: {} };
            }
            const expr = (currentEmotionMapping.expressions || {});
            currentPersistent = Array.isArray(expr['å¸¸é©»']) ? [...expr['å¸¸é©»']] : [];
        }

        function renderPersistentUI() {
            persistentBox.style.display = '';
            // å¯é€‰ï¼šæ‰€æœ‰è¡¨è¾¾å¼ - å·²é€‰ï¼ˆå¸¸é©»ï¼‰
            const unused = (currentModelFiles.expression_files || []).filter(f => !currentPersistent.includes(f));
            updateSelectWithOptions(persistentSelect, unused, 'é€‰æ‹©å¸¸é©»è¡¨æƒ…');

            // åˆ—è¡¨
            if (!currentPersistent.length) {
                persistentList.innerHTML = '<div style="color:#999;">å°šæœªæ·»åŠ å¸¸é©»è¡¨æƒ…</div>';
            } else {
                persistentList.innerHTML = currentPersistent.map(f => {
                    const name = f.split('/').pop().replace('.exp3.json','');
                    return `<div style="display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-bottom:1px dashed #eee;">
                        <span>${name}</span>
                        <button data-file="${f}" class="btn btn-secondary" style="padding:4px 8px; font-size:12px;">ç§»é™¤</button>
                    </div>`;
                }).join('');
                // ç»‘å®šç§»é™¤
                Array.from(persistentList.querySelectorAll('button[data-file]')).forEach(btn => {
                    btn.onclick = () => {
                        const file = btn.getAttribute('data-file');
                        const idx = currentPersistent.indexOf(file);
                        if (idx > -1) currentPersistent.splice(idx, 1);
                        renderPersistentUI();
                    };
                });
            }
            // å¯ç”¨ç›¸å…³æ§ä»¶
            persistentSelect.disabled = false;
            addPersistentBtn.disabled = false;
            savePersistentBtn.disabled = false;
        }

        addPersistentBtn.addEventListener('click', () => {
            const file = persistentSelect.value;
            if (!file) return;
            if (!currentPersistent.includes(file)) currentPersistent.push(file);
            renderPersistentUI();
        });

        savePersistentBtn.addEventListener('click', async () => {
            if (!currentModelInfo) return;
            showStatus('æ­£åœ¨ä¿å­˜å¸¸é©»è¡¨æƒ…...');
            try {
                // åˆå¹¶æ—§æ˜ å°„ï¼šä¿ç•™ motionsï¼Œä¿ç•™ expressions å…¶ä»–ç»„ï¼Œä»…æ›¿æ¢ å¸¸é©» ç»„
                const motions = (currentEmotionMapping && currentEmotionMapping.motions) ? currentEmotionMapping.motions : {};
                const expressions = Object.assign({}, (currentEmotionMapping && currentEmotionMapping.expressions) ? currentEmotionMapping.expressions : {});
                expressions['å¸¸é©»'] = [...currentPersistent];

                const body = { motions, expressions };
                const resp = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await resp.json();
                if (result && result.success) {
                    showStatus('å¸¸é©»è¡¨æƒ…ä¿å­˜æˆåŠŸ', 1500);
                    // é€šçŸ¥å‰ç«¯ç®¡ç†å™¨é‡æ–°åº”ç”¨å¸¸é©»ï¼Œæ— éœ€é‡è½½æ¨¡å‹
                    if (window.live2dManager && window.live2dManager.setupPersistentExpressions) {
                        await window.live2dManager.setupPersistentExpressions();
                    }
                } else {
                    showStatus('ä¿å­˜å¸¸é©»è¡¨æƒ…å¤±è´¥', 2000);
                }
            } catch (e) {
                console.error(e);
                showStatus('ä¿å­˜å¸¸é©»è¡¨æƒ…å¤±è´¥', 2000);
            }
        });

        // åŠ è½½å½“å‰è§’è‰²æ¨¡å‹çš„å‡½æ•°
        async function loadCurrentCharacterModel() {
            try {
                // ä»URLå‚æ•°ä¸­è·å–è§’è‰²åç§°
                const urlParams = new URLSearchParams(window.location.search);
                const lanlanName = urlParams.get('lanlan_name') || '';
                
                let apiUrl = '/api/characters/current_live2d_model';
                if (lanlanName) {
                    apiUrl += `?catgirl_name=${encodeURIComponent(lanlanName)}`;
                }
                
                const currentModelResponse = await fetch(apiUrl);
                const currentModelData = await currentModelResponse.json();
                
                if (!currentModelData.success) {
                    console.log('æ— æ³•è·å–å½“å‰è§’è‰²æ¨¡å‹ä¿¡æ¯:', currentModelData.error);
                    return;
                }
                
                const { catgirl_name, model_name, model_info } = currentModelData;
                
                if (model_name && model_info) {
                    // å¦‚æœè§’è‰²æœ‰è®¾ç½®çš„æ¨¡å‹ï¼Œè‡ªåŠ¨åŠ è½½
                    console.log(`è‡ªåŠ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`);
                    showStatus(`æ­£åœ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}...`);
                    
                    // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                    currentModelInfo = model_info;
                    modelSelect.value = model_name;
                    
                    // åŠ è½½æ¨¡å‹
                    await loadModel(model_name, model_info);
                    
                    showStatus(`å·²åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`);
                } else {
                    // å¦‚æœè§’è‰²æ²¡æœ‰è®¾ç½®æ¨¡å‹ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    console.log(`è§’è‰² ${catgirl_name} æœªè®¾ç½®Live2Dæ¨¡å‹`);
                    showStatus(`è§’è‰² ${catgirl_name} æœªè®¾ç½®æ¨¡å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`);
                }
            } catch (error) {
                console.error('åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥:', error);
                showStatus('åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥');
            }
        }
    });
</script>

</body>
</html>
