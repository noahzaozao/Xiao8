<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D æœ¬åœ°æ¨¡å‹æŸ¥çœ‹å™¨ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        /* CSSæ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
        html, body {
            height: 100%; margin: 0; padding: 0; background: #fff; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }
        #chat-container { pointer-events: auto; position: fixed; left: 20px; bottom: 20px; width: 340px;
            height: 300px; background: #f7f8fa; opacity: 0.7; border-radius: 12px; padding: 16px;
            box-sizing: border-box; z-index: 20; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column; }
        #chat-content-wrapper { flex-grow: 1; padding-left: 8px; overflow-y: auto; opacity: 0.7; }
        #sidebar {
            /*background: #f7f8fa;*/
            /*opacity: 0.7;*/
            border-radius: 12px;
            box-sizing: border-box;
            box-shadow: None;

            background: transparent;
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 20;
            min-width: 150px;
            transition: width 0.3s ease, min-width 0.3s ease, height 0.3s ease, padding 0.3s ease, opacity 0.3s;
        }
        .side-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #333;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .side-btn:active {
            background: #555;
        }

        .side-btn:disabled {
            background: #e0e0e0;
            color: #888;
            cursor: not-allowed;
            border: 1px solid #ccc;
            opacity: 0.7;
        }

        .side-btn:hover:not(:disabled) {
            background: #4f8cff;
            color: #fff;
        }
        #status {
            /*margin-top: 5px;*/
            color: #4f8cff;
            background: transparent;
            font-size: 0.95rem;
            max-width: 150px;
            word-break: break-all;
        }
        #model-list-container { display: none; flex-direction: column; gap: 8px; margin-top: 10px; width: 130px;}
        .model-select-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;
            background: #fff; cursor: pointer; text-align: left; }
        .model-select-btn:hover { background: #e8f0fe; border-color: #4f8cff; }
        .save-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #4f8cff;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .save-btn:hover { background: #2662c8; }
        .save-btn:disabled { background: #b0c4de; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="sidebar">
    <button id="fullscreenBtn" class="side-btn">ğŸ–¥ï¸ å…¨å±</button>
    <button id="exitFullscreenBtn" class="side-btn" style="display:none;">âŒ é€€å‡ºå…¨å±</button>
    <button id="changeModelBtn" class="side-btn">ğŸ”„ï¸ æ›´æ¢æ¨¡å‹</button>
    <div id="model-list-container"></div>
    <button id="savePreferencesBtn" class="save-btn" disabled>ğŸ’¾ ä¿å­˜è®¾ç½®</button>
    <button id="micButton" class="side-btn" disabled>ğŸ¤ å¼€å§‹èŠå¤©</button>
    <button id="muteButton" class="side-btn" disabled>â¸ï¸ ä¼‘æ¯ä¸€ä¸‹</button>
    <div id="status">æ­£åœ¨ä»æœåŠ¡å™¨è·å–æ¨¡å‹åˆ—è¡¨...</div>
    <!-- <button id="screenButton" class="side-btn" disabled>ğŸ–¥ï¸ å±å¹•å…±äº«</button>
    <button id="stopButton" class="side-btn" disabled>ğŸ›‘ æš‚åœå…±äº«</button> -->
    <!-- <button id="resetSessionButton" class="side-btn" disabled>ğŸ‘‹ è¯·å¥¹ç¦»å¼€</button> -->
</div>
<div id="chat-container">
    <div id="chat-content-wrapper"><p style="color: #888">å¯¹è¯å†å²ç•Œé¢<br><br>...ç°åœ¨æ˜¯ä¸€ç‰‡ç©ºç™½...</p></div>
</div>
<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>  <!-- Cubism 4æ ¸å¿ƒåº“ï¼ˆæ”¯æŒCubism 3/4æ¨¡å‹ï¼‰ -->
<script src="/static/libs/live2d.min.js"></script>  <!-- Cubism 2.1æ ¸å¿ƒåº“ï¼ˆæ”¯æŒæ—§æ¨¡å‹ï¼‰ -->
<script src="/static/libs/pixi.min.js"></script>  <!-- PixiJS v7 CDN -->
<script src="/static/libs/index.min.js"></script>  <!-- pixi-live2d-display v0.5.0-ls-6ï¼ˆRaSan147 forkï¼Œæ”¯æŒv7ï¼‰ -->
<script src="/static/live2d.js"></script>  <!-- ä½¿ç”¨é‡æ„åçš„ Live2D ç®¡ç†å™¨ -->

<script>
    // æ³¨å…¥åç«¯ä¼ æ¥çš„ lanlan_name å˜é‡
    const lanlanName = "{{ lanlan_name | default('') }}";
    
    (async function () {
        const statusDiv = document.getElementById('status');
        let currentModelInfo = null;

        // åˆå§‹åŒ– Live2D ç®¡ç†å™¨
        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');

        // è®¾ç½®æ¨¡å‹åŠ è½½å›è°ƒ
        window.live2dManager.onModelLoaded = (model, modelPath) => {
            console.log('æ¨¡å‹åŠ è½½å®Œæˆ:', modelPath);
            if (currentModelInfo) {
                statusDiv.innerText = `åŠ è½½æˆåŠŸ: ${currentModelInfo.name}ã€‚æ‚¨å¯ä»¥æ‹–æ‹½å’Œæ»šè½®ç¼©æ”¾æ¨¡å‹ã€‚`;
            }
            document.getElementById('savePreferencesBtn').disabled = false;
        };

        // è®¾ç½®çŠ¶æ€æ›´æ–°å›è°ƒ
        window.live2dManager.onStatusUpdate = (message) => {
            statusDiv.innerText = message;
        };

        async function setupModelList() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                const modelsFromServer = await response.json();
                const modelListContainer = document.getElementById('model-list-container');
                modelListContainer.innerHTML = '';
                
                if (modelsFromServer.length > 0) {
                    modelsFromServer.forEach(modelInfo => {
                        const btn = document.createElement('button');
                        btn.innerText = modelInfo.name;
                        btn.className = 'model-select-btn';
                        btn.onclick = async () => { 
                            const preferences = await window.live2dManager.loadUserPreferences();
                            // æŸ¥æ‰¾è¯¥æ¨¡å‹çš„å†å²åå¥½
                            const modelPreferences = preferences.find(pref => pref && pref.model_path === modelInfo.path);
                            await loadModel(modelInfo, modelPreferences || null); 
                            // å°†è¯¥æ¨¡å‹è®¾ä¸ºé¦–é€‰
                            try {
                                await fetch('/api/preferences/set-preferred', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ model_path: modelInfo.path })
                                });
                            } catch (error) {
                                console.warn('è®¾ç½®é¦–é€‰æ¨¡å‹å¤±è´¥:', error);
                            }
                            modelListContainer.style.display = 'none'; 
                            document.getElementById('changeModelBtn').innerText = 'ğŸ”„ï¸ æ›´æ¢æ¨¡å‹'; 
                        };
                        modelListContainer.appendChild(btn);
                    });
                    
                    // åŠ è½½ç”¨æˆ·åå¥½
                    const preferences = await window.live2dManager.loadUserPreferences();
                    console.log('åŠ è½½çš„ç”¨æˆ·åå¥½:', preferences);
                    let modelToLoad = modelsFromServer[0]; // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å‹
                    let modelPreferences = null;
                    
                    // å¦‚æœæœ‰ä¿å­˜çš„åå¥½ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹
                    if (preferences.length > 0 && preferences[0] && preferences[0].model_path) {
                        const savedModel = modelsFromServer.find(model => model.path === preferences[0].model_path);
                        console.log('æŸ¥æ‰¾ä¿å­˜çš„æ¨¡å‹:', preferences[0].model_path, 'æ‰¾åˆ°:', savedModel);
                        if (savedModel) {
                            modelToLoad = savedModel;
                            modelPreferences = preferences[0];
                            statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œæ­£åœ¨åŠ è½½é¦–é€‰æ¨¡å‹: ${savedModel.name}`;
                        } else {
                            statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œé¦–é€‰æ¨¡å‹ä¸å¯ç”¨ï¼ŒåŠ è½½é»˜è®¤æ¨¡å‹ã€‚`;
                        }
                    } else {
                        statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œè¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©ã€‚`;
                    }
                    
                    // åŠ è½½æ¨¡å‹å¹¶åº”ç”¨åå¥½è®¾ç½®
                    await loadModel(modelToLoad, modelPreferences);
                } else {
                    statusDiv.innerText = 'æœåŠ¡å™¨çš„ "static" æ–‡ä»¶å¤¹ä¸‹æœªå‘ç°ä»»ä½•æ¨¡å‹ã€‚';
                }
            } catch (error) { 
                console.error("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:", error); 
                statusDiv.innerText = 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚'; 
            }
        }

        async function loadModel(modelInfo, preferences = {}) {
            if (!modelInfo || !modelInfo.path) { 
                statusDiv.innerText = "é”™è¯¯ï¼šæ¨¡å‹è·¯å¾„æ— æ•ˆã€‚"; 
                return; 
            }
            
            currentModelInfo = modelInfo;
            statusDiv.innerText = `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelInfo.name}...`;
            
            try {
                // ä½¿ç”¨ Live2D ç®¡ç†å™¨åŠ è½½æ¨¡å‹
                await window.live2dManager.loadModel(modelInfo.path, {
                    preferences: preferences,
                    dragEnabled: true,
                    wheelEnabled: true,
                    loadEmotionMapping: true
                });

                // è®¾ç½®çª—å£å¤§å°å˜åŒ–ç›‘å¬
                window.addEventListener('resize', () => {
                    const model = window.live2dManager.getCurrentModel();
                    if (model && preferences && preferences.position) {
                        model.x = preferences.position.x;
                        model.y = preferences.position.y;
                    } else if (model) {
                        model.x = window.live2dManager.getPIXIApp().renderer.width;
                        model.y = window.live2dManager.getPIXIApp().renderer.height;
                    }
                });

                statusDiv.innerText = `åŠ è½½æˆåŠŸ: ${modelInfo.name}ã€‚æ‚¨å¯ä»¥æ‹–æ‹½å’Œæ»šè½®ç¼©æ”¾æ¨¡å‹ã€‚`;
                document.getElementById('savePreferencesBtn').disabled = false;
            } catch (error) { 
                console.error("åŠ è½½æ¨¡å‹å¤±è´¥:", error); 
                statusDiv.innerText = `åŠ è½½æ¨¡å‹ "${modelInfo.name}" å¤±è´¥ã€‚è¯·æ£€æŸ¥è·¯å¾„æˆ–F12æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ã€‚`; 
            }
        }

        // ä¿å­˜ç”¨æˆ·åå¥½
        async function saveUserPreferences() {
            const currentModel = window.live2dManager.getCurrentModel();
            if (!currentModel || !currentModelInfo) {
                statusDiv.innerText = "æ²¡æœ‰å¯ä¿å­˜çš„è®¾ç½®";
                return;
            }
            
            try {
                const success = await window.live2dManager.saveUserPreferences(
                    currentModelInfo.path,
                    { x: currentModel.x, y: currentModel.y },
                    { x: currentModel.scale.x, y: currentModel.scale.y }
                );
                
                if (success) {
                    statusDiv.innerText = "è®¾ç½®å·²ä¿å­˜ï¼";
                    setTimeout(() => {
                        if (currentModelInfo) {
                            statusDiv.innerText = `å½“å‰æ¨¡å‹: ${currentModelInfo.name}`;
                        }
                    }, 2000);
                } else {
                    statusDiv.innerText = "ä¿å­˜å¤±è´¥";
                }
            } catch (error) {
                console.error("ä¿å­˜åå¥½å¤±è´¥:", error);
                statusDiv.innerText = "ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥";
            }
            
            // ä¿å­˜ live2d å­—æ®µåˆ°åç«¯
            if (lanlanName && currentModelInfo && currentModelInfo.name) {
                try {
                    const resp = await fetch(`/api/characters/catgirl/l2d/${lanlanName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ live2d: currentModelInfo.name })
                    });
                    const result = await resp.json();
                    if (!result.success) {
                        statusDiv.innerText += `\nåç«¯ä¿å­˜live2då¤±è´¥: ${result.error}`;
                    }
                } catch (e) {
                    statusDiv.innerText += '\nåç«¯ä¿å­˜live2då¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                }
            }
        }

        document.getElementById('changeModelBtn').addEventListener('click', () => {
            const modelListContainer = document.getElementById('model-list-container');
            const isVisible = modelListContainer.style.display === 'flex';
            if (isVisible) {
                modelListContainer.style.display = 'none';
                document.getElementById('changeModelBtn').innerText = 'ğŸ”„ï¸ æ›´æ¢æ¨¡å‹';
            } else {
                modelListContainer.style.display = 'flex';
                document.getElementById('changeModelBtn').innerText = 'ğŸ”¼ æ”¶èµ·åˆ—è¡¨';
                statusDiv.innerText = "è‡ªåŠ¨æ£€ç´¢Live2Dæ¨¡å‹...\nè¯·å°†æ¨¡å‹æ–‡ä»¶ç½®äº\n/staticæ–‡ä»¶å¤¹å†…ã€‚";
            }
        });

        // ä¿å­˜åå¥½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('savePreferencesBtn').addEventListener('click', saveUserPreferences);
        
        setupModelList();

    })();

    // å…¨å±/é€€å‡ºå…¨å±æŒ‰é’®é€»è¾‘
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
    fullscreenBtn.onclick = function() {
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
        } else if (document.documentElement.mozRequestFullScreen) {
            document.documentElement.mozRequestFullScreen();
        } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
        }
    };
    exitFullscreenBtn.onclick = function() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    };
    // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œåˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
    function updateFullscreenButtons() {
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        fullscreenBtn.style.display = isFullscreen ? 'none' : '';
        exitFullscreenBtn.style.display = isFullscreen ? '' : 'none';
    }
    document.addEventListener('fullscreenchange', updateFullscreenButtons);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButtons);
    document.addEventListener('mozfullscreenchange', updateFullscreenButtons);
    document.addEventListener('MSFullscreenChange', updateFullscreenButtons);
    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateFullscreenButtons();
</script>

</body>
</html>