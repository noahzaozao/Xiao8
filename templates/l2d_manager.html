<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D æ¨¡å‹ç®¡ç†å™¨</title>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; background: #eee; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            min-width: 280px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .control-select, .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
        }
        .btn {
            color: white;
            border: none;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-primary { background: #667eea; }
        .btn-primary:hover:not(:disabled) { background: #5a6fd8; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .btn-success { background: #28a745; }
        .btn-success:hover:not(:disabled) { background: #218838; }

        .action-group {
            display: flex;
            gap: 10px;
        }
        .action-group .control-select {
            flex-grow: 1;
        }
        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
        #chat-container { 
            pointer-events: auto; 
            position: fixed; 
            left: 20px; 
            bottom: 20px; 
            width: 340px;
            height: 300px; 
            background: rgba(247, 248, 250, 0.7);
            border-radius: 12px; 
            padding: 16px;
            box-sizing: border-box; 
            z-index: 20; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; 
            flex-direction: column; 
            backdrop-filter: blur(10px);
        }
        #chat-content-wrapper { 
            flex-grow: 1; 
            padding-left: 8px; 
            overflow-y: auto; 
            opacity: 0.7; 
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="control-group">
        <button id="fullscreenBtn" class="btn btn-secondary">ğŸ–¥ï¸ å…¨å±</button>
        <button id="exitFullscreenBtn" class="btn btn-secondary" style="display:none;">âŒ é€€å‡ºå…¨å±</button>
    </div>
    <div class="control-group">
        <label for="model-select" class="control-label">é€‰æ‹©æ¨¡å‹:</label>
        <select id="model-select" class="control-select">
            <option>åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div class="control-group">
        <label class="control-label">åŠ¨ä½œé¢„è§ˆ:</label>
        <div class="action-group">
            <select id="motion-select" class="control-select" disabled>
                <option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-motion-btn" class="btn btn-primary" disabled>æ’­æ”¾</button>
        </div>
    </div>
    
    <div class="control-group">
        <label class="control-label">è¡¨æƒ…é¢„è§ˆ:</label>
        <div class="action-group">
            <select id="expression-select" class="control-select" disabled>
                <option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-expression-btn" class="btn btn-primary" disabled>æ’­æ”¾</button>
        </div>
    </div>

    <div class="control-group">
        <div style="display:flex; gap: 10px;">
            <button id="emotion-manager-btn" class="btn btn-secondary" disabled style="flex:1;">âš™ï¸ æƒ…æ„Ÿé…ç½®</button>
            <button id="save-position-btn" class="btn btn-success" disabled style="flex:1;">ğŸ’¾ ä¿å­˜ä½ç½®</button>
        </div>
    </div>
    
    <div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
</div>

<div id="chat-container">
    <div id="chat-content-wrapper"><p style="color: #888">å¯¹è¯å†å²ç•Œé¢<br><br>...ç°åœ¨æ˜¯ä¸€ç‰‡ç©ºç™½...</p></div>
</div>

<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>
<script src="/static/libs/live2d.min.js"></script>
<script src="/static/libs/pixi.min.js"></script>
<script src="/static/libs/index.min.js"></script>
<script src="/static/live2d.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const statusDiv = document.getElementById('status');
        const modelSelect = document.getElementById('model-select');
        const motionSelect = document.getElementById('motion-select');
        const expressionSelect = document.getElementById('expression-select');
        const playMotionBtn = document.getElementById('play-motion-btn');
        const playExpressionBtn = document.getElementById('play-expression-btn');
        const emotionManagerBtn = document.getElementById('emotion-manager-btn');
        const savePositionBtn = document.getElementById('save-position-btn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');

        let currentModelInfo = null;
        let availableModels = [];
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let live2dModel = null;

        const showStatus = (msg, duration = 0) => {
            statusDiv.textContent = msg;
            if (duration > 0) {
                setTimeout(() => {
                    if (currentModelInfo) {
                        showStatus(`å½“å‰æ¨¡å‹: ${currentModelInfo.name}`);
                    }
                }, duration);
            }
        };

        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
        showStatus('PIXI åˆå§‹åŒ–å®Œæˆ');

        try {
            const response = await fetch('/api/live2d/models');
            availableModels = await response.json();
            if (availableModels.length > 0) {
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹</option>';
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
                showStatus('æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ');
            } else {
                showStatus('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹');
            }
        } catch (e) {
            showStatus('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
        }

        modelSelect.addEventListener('change', async (e) => {
            const modelName = e.target.value;
            if (!modelName) return;

            currentModelInfo = availableModels.find(m => m.name === modelName);
            if (!currentModelInfo) return;

            showStatus(`æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelName}...`);
            setControlsDisabled(true);

            try {
                // 1. Fetch files list
                const filesRes = await fetch(`/api/live2d/model_files/${modelName}`);
                const filesData = await filesRes.json();
                if (!filesData.success) throw new Error('æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶åˆ—è¡¨');
                currentModelFiles = filesData;

                // 2. Fetch model config
                const modelJsonUrl = currentModelInfo.path;
                const modelConfigRes = await fetch(modelJsonUrl);
                if (!modelConfigRes.ok) throw new Error(`æ— æ³•è·å–æ¨¡å‹é…ç½®: ${modelConfigRes.statusText}`);
                const modelConfig = await modelConfigRes.json();
                
                // 3. Add URL context for the loader
                modelConfig.url = modelJsonUrl;

                // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                // Motions
                if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                    File: `motions/${file}`
                }));

                // Expressions: Overwrite with all available expression files for preview purposes.
                modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                    Name: file.replace('.exp3.json', ''),
                    File: `expressions/${file}`
                }));
                
                // 5. Load preferences
                const preferences = await window.live2dManager.loadUserPreferences();
                const modelPreferences = preferences.find(p => p && p.model_path === currentModelInfo.path) || null;

                // 6. Load model FROM THE MODIFIED OBJECT
                await window.live2dManager.loadModel(modelConfig, {
                    loadEmotionMapping: true,
                    dragEnabled: true,
                    wheelEnabled: true,
                    preferences: modelPreferences
                });
                live2dModel = window.live2dManager.getCurrentModel();

                updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, 'é€‰æ‹©åŠ¨ä½œ');
                updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, 'é€‰æ‹©è¡¨æƒ…');
                setControlsDisabled(false);
                showStatus(`æ¨¡å‹ ${modelName} åŠ è½½æˆåŠŸ`);

            } catch (error) {
                showStatus(`åŠ è½½æ¨¡å‹ ${modelName} å¤±è´¥`);
                console.error(error);
            }
        });

        playMotionBtn.addEventListener('click', () => {
            if (!live2dModel || !motionSelect.value) return;
            const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
            if (motionIndex > -1) {
                live2dModel.motion('PreviewAll', motionIndex, 3);
            }
        });

        playExpressionBtn.addEventListener('click', () => {
            if (!live2dModel || !expressionSelect.value) return;
            const expressionName = expressionSelect.value.replace('.exp3.json', '');
            live2dModel.expression(expressionName);
        });

        emotionManagerBtn.addEventListener('click', () => {
            if (!currentModelInfo) return;
            openModal('/live2d_emotion_manager');
        });

        savePositionBtn.addEventListener('click', async () => {
            if (!currentModelInfo || !live2dModel) return;
            showStatus('æ­£åœ¨ä¿å­˜ä½ç½®...');
            const success = await window.live2dManager.saveUserPreferences(
                currentModelInfo.path,
                { x: live2dModel.x, y: live2dModel.y },
                { x: live2dModel.scale.x, y: live2dModel.scale.y }
            );
            if (success) {
                showStatus('ä½ç½®ä¿å­˜æˆåŠŸ!', 2000);
            } else {
                showStatus('ä½ç½®ä¿å­˜å¤±è´¥!', 2000);
            }
        });
        
        // Fullscreen logic
        fullscreenBtn.onclick = () => document.documentElement.requestFullscreen?.();
        exitFullscreenBtn.onclick = () => document.exitFullscreen?.();
        const updateFullscreenButtons = () => {
            const isFullscreen = !!document.fullscreenElement;
            fullscreenBtn.style.display = isFullscreen ? 'none' : '';
            exitFullscreenBtn.style.display = isFullscreen ? '' : 'none';
        };
        document.addEventListener('fullscreenchange', updateFullscreenButtons);
        updateFullscreenButtons();

        // Helper functions
        function setControlsDisabled(disabled) {
            motionSelect.disabled = disabled;
            expressionSelect.disabled = disabled;
            playMotionBtn.disabled = disabled;
            playExpressionBtn.disabled = disabled;
            emotionManagerBtn.disabled = disabled;
            savePositionBtn.disabled = disabled;
        }

        function updateSelectWithOptions(select, options, defaultText) {
            select.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function openModal(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

            const header = document.createElement('div');
            header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;
            
            const title = document.createElement('h3');
            title.textContent = 'æƒ…æ„Ÿé…ç½®ç®¡ç†å™¨';
            title.style.cssText = 'margin: 0;';

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Ã—';
            closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

            const closeModal = () => {
                modal.remove();
                if (currentModelInfo) {
                    modelSelect.value = currentModelInfo.name;
                    modelSelect.dispatchEvent(new Event('change'));
                }
            };
            
            closeButton.onclick = closeModal;
            header.appendChild(title);
            header.appendChild(closeButton);
            iframeContainer.appendChild(header);
            iframeContainer.appendChild(iframe);
            modal.appendChild(iframeContainer);
            document.body.appendChild(modal);
        }
    });
</script>

</body>
</html>
