function o(){if(typeof window>"u")return console.warn("[RequestAPI] 非浏览器环境"),null;const r=window;return r.request?r.request:(console.warn("[RequestAPI] window.request 未初始化，请确保已加载 request.global.js"),null)}async function g(r){const e=o();if(!e)throw new Error("request 实例未初始化，请确保已加载 request.global.js");try{const t=r?`/api/config/page_config?lanlan_name=${encodeURIComponent(r)}`:"/api/config/page_config",n=await e.get(t);if(n&&n.success)return n;throw new Error(n?.error||"获取页面配置失败")}catch(t){throw console.error("[getPageConfig] 获取页面配置失败:",t),t}}async function i(){const r=o();if(!r)throw new Error("request 实例未初始化，请确保已加载 request.global.js");try{return await r.get("/api/characters")}catch(e){throw console.error("[getCharacters] 获取角色配置失败:",e),e}}async function l(){const r=o();if(!r)throw new Error("request 实例未初始化，请确保已加载 request.global.js");try{const e=await r.get("/api/live2d/models");return Array.isArray(e)?e:[]}catch(e){throw console.error("[getLive2DModels] 获取 Live2D 模型列表失败:",e),e}}async function f(r){try{return(await l()).find(n=>n.name===r)||null}catch(e){return console.error("[findLive2DModelByName] 查找模型失败:",e),null}}async function d(r=!0){const e=o(),t={timestamp:Date.now(),action:"shutdown"};try{if(r&&typeof navigator<"u"&&navigator.sendBeacon){if(navigator.sendBeacon("/api/beacon/shutdown",JSON.stringify(t)))return console.log("[sendShutdownBeacon] Beacon 信号已发送"),!0;console.warn("[sendShutdownBeacon] Beacon 发送失败，尝试使用 request")}if(e)return await e.post("/api/beacon/shutdown",t),console.log("[sendShutdownBeacon] 使用 request 发送关闭信号成功"),!0;{const n=await fetch("/api/beacon/shutdown",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0});if(n.ok)return console.log("[sendShutdownBeacon] 使用 fetch 发送关闭信号成功"),!0;throw new Error(`HTTP ${n.status}: ${n.statusText}`)}}catch(n){return console.error("[sendShutdownBeacon] 发送关闭信号失败:",n),!1}}async function w(r){try{const e=await i(),t=r||e.当前猫娘;if(!t)return console.warn("[getCurrentCatgirlConfig] 未找到当前猫娘名称"),null;const n=e.猫娘?.[t];return n?{name:t,...n}:(console.warn(`[getCurrentCatgirlConfig] 未找到角色 ${t} 的配置`),null)}catch(e){return console.error("[getCurrentCatgirlConfig] 获取猫娘配置失败:",e),null}}async function h(r,e){try{const t=await f(e);if(!t)return console.warn(`[shouldReloadModel] 未找到模型 ${e}`),!1;const n=t.path;if(!r)return!0;const s=r.split("/").filter(Boolean).pop()||"",a=n.split("/").filter(Boolean).pop()||"";return!n.includes(s)&&s!==a}catch(t){return console.error("[shouldReloadModel] 检查模型是否需要重新加载失败:",t),!1}}async function p(r){const e=o();if(!e)return console.warn("[getEmotionMapping] request 实例未初始化"),null;try{if(!r)return console.warn("[getEmotionMapping] 模型名称为空"),null;const t=await e.get(`/api/live2d/emotion_mapping/${encodeURIComponent(r)}`);return t&&t.success&&t.config?t:(console.warn("[getEmotionMapping] 获取情绪映射失败:",t),null)}catch(t){return console.error("[getEmotionMapping] 获取情绪映射失败:",t),null}}async function y(r){const e=o();if(!e)return console.warn("[unlockSteamAchievement] request 实例未初始化"),!1;try{return(await e.post(`/api/steam/set-achievement-status/${r}`,{}))?.success===!0}catch(t){return console.error("[unlockSteamAchievement] 解锁成就失败:",t),!1}}async function q(r){const e=o();if(!e)return console.warn("[setMicrophone] request 实例未初始化"),!1;try{return(await e.post("/api/characters/set_microphone",{microphone_id:r}))?.success!==!1}catch(t){return console.error("[setMicrophone] 保存麦克风选择失败:",t),!1}}async function m(){const r=o();if(!r)return console.warn("[getMicrophone] request 实例未初始化"),null;try{return(await r.get("/api/characters/get_microphone"))?.microphone_id||null}catch(e){return console.error("[getMicrophone] 获取麦克风选择失败:",e),null}}async function A(r,e){const t=o();if(!t)return console.warn("[analyzeEmotion] request 实例未初始化"),null;try{const n=await t.post("/api/emotion/analysis",{text:r,lanlan_name:e});return n?.error?(console.warn("[analyzeEmotion] 情感分析错误:",n.error),null):n}catch(n){return console.error("[analyzeEmotion] 情感分析失败:",n),null}}async function v(r){const e=o();if(!e)return console.warn("[getCurrentLive2DModel] request 实例未初始化"),null;try{return await e.get(`/api/characters/current_live2d_model?catgirl_name=${encodeURIComponent(r)}`)}catch(t){return console.error("[getCurrentLive2DModel] 获取当前Live2D模型失败:",t),null}}async function C(){const r=o();if(!r)return console.warn("[checkAgentHealth] request 实例未初始化"),!1;try{const e=await r.get("/api/agent/health");return e?.success===!0||e===!0}catch(e){return console.error("[checkAgentHealth] Agent健康检查失败:",e),!1}}async function P(r){const e=o();if(!e)return console.warn("[checkAgentCapability] request 实例未初始化"),!1;try{const n={computer_use:"/api/agent/computer_use/availability",mcp:"/api/agent/mcp/availability"}[r];return n?(await e.get(n))?.ready===!0:(console.warn("[checkAgentCapability] 未知的能力类型:",r),!1)}catch(t){return console.error("[checkAgentCapability] 检查Agent能力失败:",t),!1}}async function M(){const r=o();if(!r)return console.warn("[getAgentFlags] request 实例未初始化"),null;try{const e=await r.get("/api/agent/flags");return e?.success?e:null}catch(e){return console.error("[getAgentFlags] 获取Agent flags失败:",e),null}}async function b(r,e){const t=o();if(!t)return console.warn("[setAgentFlags] request 实例未初始化"),!1;try{return(await t.post("/api/agent/flags",{lanlan_name:r,flags:e}))?.success!==!1}catch(n){return console.error("[setAgentFlags] 设置Agent flags失败:",n),!1}}async function R(r){const e=o();if(!e)return console.warn("[controlAgent] request 实例未初始化"),!1;try{return(await e.post("/api/agent/admin/control",{action:r}))?.success!==!1}catch(t){return console.error("[controlAgent] Agent控制失败:",t),!1}}async function _(){const r=o();if(!r)return console.warn("[getAgentTaskStatus] request 实例未初始化"),null;try{const e=await r.get("/api/agent/task_status");return e?.success?e:null}catch(e){return console.error("[getAgentTaskStatus] 获取Agent任务状态失败:",e),null}}async function I(r){const e=o();if(!e)return console.warn("[triggerProactiveChat] request 实例未初始化"),null;try{return await e.post("/api/proactive_chat",{lanlan_name:r})}catch(t){return console.error("[triggerProactiveChat] 触发主动搭话失败:",t),null}}async function k(){const r=o();if(!r)return console.warn("[getUserPreferences] request 实例未初始化"),[];try{const e=await r.get("/api/preferences");return Array.isArray(e)?e:[]}catch(e){return console.error("[getUserPreferences] 获取用户偏好失败:",e),[]}}async function S(r,e,t){const n=o();if(!n)return console.warn("[saveUserPreferences] request 实例未初始化"),!1;try{if(!e||typeof e!="object"||!Number.isFinite(e.x)||!Number.isFinite(e.y))return console.error("[saveUserPreferences] 位置值无效:",e),!1;if(!t||typeof t!="object"||!Number.isFinite(t.x)||!Number.isFinite(t.y))return console.error("[saveUserPreferences] 缩放值无效:",t),!1;if(t.x<=0||t.y<=0)return console.error("[saveUserPreferences] 缩放值必须为正数:",t),!1;const s={model_path:r,position:e,scale:t};return(await n.post("/api/preferences",s))?.success===!0}catch(s){return console.error("[saveUserPreferences] 保存用户偏好失败:",s),!1}}const c={getPageConfig:g,getCharacters:i,getCurrentCatgirlConfig:w,getLive2DModels:l,findLive2DModelByName:f,shouldReloadModel:h,getEmotionMapping:p,getCurrentLive2DModel:v,getUserPreferences:k,saveUserPreferences:S,unlockSteamAchievement:y,setMicrophone:q,getMicrophone:m,analyzeEmotion:A,checkAgentHealth:C,checkAgentCapability:P,getAgentFlags:M,setAgentFlags:b,controlAgent:R,getAgentTaskStatus:_,triggerProactiveChat:I,sendShutdownBeacon:d};function u(){if(typeof window>"u"){console.warn("[RequestAPI] 非浏览器环境，跳过初始化");return}const r=window;r.RequestAPI=c,console.log("[RequestAPI] API 命名空间已暴露到全局 window.RequestAPI"),console.log("[RequestAPI] 可用方法:",Object.keys(c).join(", "))}if(typeof window<"u"){const r=async()=>{const t=Date.now();for(;!window.request&&Date.now()-t<5e3;)await new Promise(n=>setTimeout(n,50));window.request||console.warn("[RequestAPI] 等待 request.global.js 初始化超时，RequestAPI 可能无法正常工作"),u()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r()}
